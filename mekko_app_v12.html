<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mekko Chart Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* Custom styles for smooth transitions and specific elements */
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        #app {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
        }

        #sidebar {
            --sidebar-base-font-size: 14px;
            font-size: var(--sidebar-base-font-size);
            width: var(--sidebar-width, 350px);
            min-width: 280px;
            max-width: 50%;
            background-color: #f8fafc;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease-in-out, width 0.3s ease-in-out;
            transform: translateX(0);
            overflow-y: auto;
            padding: 1rem;
            flex-shrink: 0;
            z-index: 10;
            position: relative;
        }

        #sidebar.hidden {
            transform: translateX(-100%);
            width: 0;
            padding: 0;
            min-width: 0;
        }

        #sidebar-resizer {
            position: absolute;
            top: 0;
            right: 0;
            width: 8px;
            height: 100%;
            cursor: ew-resize;
            z-index: 11;
        }
        #sidebar-resizer:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }

        #chart-container {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #ffffff;
            position: relative;
            overflow: hidden;
            transition: width 0.3s ease-in-out, margin-left 0.3s ease-in-out;
        }

        #toggle-sidebar-btn {
            position: absolute;
            top: 1rem;
            left: 1rem;
            z-index: 20;
            background-color: rgba(203, 213, 225, 0.5);
            color: #475569;
            border-radius: 9999px;
            width: 32px;
            height: 32px;
            padding: 0;
            box-shadow: none;
            border: 1px solid rgba(226, 232, 240, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease-in-out;
        }
        #toggle-sidebar-btn:hover {
            background-color: rgba(148, 163, 184, 0.7);
            color: #1e293b;
        }

        /* Styling for the data input grid */
        .data-grid-container {
            overflow: auto; /* Changed to auto for better scrollbar handling */
            margin-top: 0.75rem;
        }

        .data-grid {
            width: 100%;
            border-collapse: collapse;
            font-size: inherit;
        }

        .data-grid th, .data-grid td {
            border: 1px solid #e2e8f0;
            padding: 0;
            text-align: center;
            min-width: 80px; /* Ensure columns have a minimum width */
        }

        .data-grid th {
            background-color: #f1f5f9;
            font-weight: 600;
            padding: 0.2rem 0.1rem;
        }

        .data-grid input[type="text"],
        .data-grid input[type="number"] {
            width: 100%;
            padding: 0.2rem;
            border: none;
            border-radius: 0;
            text-align: center;
            background-color: transparent; /* Allow cell color to show through */
            font-family: 'Inter', sans-serif;
            font-size: inherit;
        }

        .data-grid input[type="number"]::-webkit-inner-spin-button,
        .data-grid input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .data-grid input[type="number"] {
            -moz-appearance: textfield;
        }

        /* D3 chart specific styles */
        .chart-svg { width: 100%; height: 100%; }
        .axis path, .axis line { fill: none; stroke: #cbd5e1; shape-rendering: crispEdges; }
        .grid line { stroke: #e2e8f0; stroke-opacity: 0.7; shape-rendering: crispEdges; }
        .segment-label { text-anchor: middle; pointer-events: none; }
        .column-label { text-anchor: middle; }
        .leader-line { stroke: #9ca3af; stroke-width: 1px; stroke-dasharray: 2,2; }
        .chart-title { font-weight: 700; text-anchor: middle; }
        .axis-title { font-weight: 600; text-anchor: middle; }
        .legend-item { cursor: pointer; }

        /* Sidebar Accordion Styles */
        .sidebar-accordion details {
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            background-color: #ffffff;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .sidebar-accordion summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            font-weight: 600;
            cursor: pointer;
            list-style: none;
        }
        .sidebar-accordion summary::-webkit-details-marker { display: none; }
        .sidebar-accordion summary .accordion-icon { transition: transform 0.2s; }
        .sidebar-accordion details[open] summary .accordion-icon { transform: rotate(90deg); }
        .sidebar-accordion .accordion-content { padding: 0 1rem 1rem 1rem; border-top: 1px solid #e2e8f0; }
        .sidebar-label { font-size: inherit; margin-bottom: 0.25rem; display: block; }
        .sidebar-input, .sidebar-select {
            padding: 0.375rem;
            font-size: inherit;
            width: 100%;
            border-radius: 0.375rem;
            border: 1px solid #cbd5e1;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            #sidebar { position: absolute; height: 100%; left: 0; top: 0; --sidebar-width: 100vw; }
            #sidebar.hidden { transform: translateX(-100%); }
            #sidebar:not(.hidden) { transform: translateX(0); }
            #toggle-sidebar-btn { left: 1rem; right: auto; top: 1rem; transform: translateX(0); }
            #chart-container { width: 100%; }
            #sidebar-resizer { display: none; }
        }

        /* Footer Styles */
        #app-footer {
            flex-shrink: 0;
            padding: 0.5rem 1rem;
            text-align: center;
            font-size: 0.875rem;
            color: #64748b;
            background-color: #f8fafc;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.75rem;
        }
        #app-footer a { color: #3b82f6; text-decoration: none; font-weight: 500; }
        #app-footer a:hover { text-decoration: underline; }
        #info-icon { cursor: pointer; color: #9ca3af; }
        #info-icon:hover { color: #4b5563; }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            text-align: center;
            max-width: 90%;
            width: 450px;
            font-family: 'Inter', sans-serif;
            color: #1e293b;
            position: relative;
            transform: scale(0.95);
            transition: transform 0.3s;
        }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-content h3 { font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; }
        .modal-buttons { display: flex; justify-content: center; gap: 1rem; margin-top: 1.5rem; }
        .modal-button { padding: 0.5rem 1.25rem; border-radius: 0.375rem; font-weight: 500; cursor: pointer; transition: background-color 0.2s, border-color 0.2s; }
        .modal-button.confirm { background-color: #ef4444; color: white; border: 1px solid #ef4444; }
        .modal-button.confirm:hover { background-color: #dc2626; }
        .modal-button.cancel { background-color: #f1f5f9; color: #334155; border: 1px solid #cbd5e1; }
        .modal-button.cancel:hover { background-color: #e2e8f0; }
        .modal-close-btn { position: absolute; top: 0.75rem; right: 0.75rem; background: none; border: none; cursor: pointer; color: #9ca3af; }
        .modal-close-btn:hover { color: #4b5563; }
        #about-modal .modal-content { text-align: left; }
        #about-modal h4 { font-weight: 600; margin-top: 1rem; margin-bottom: 0.5rem; }
        #about-modal p, #about-modal a { font-size: 0.875rem; color: #475569; }
        #about-modal a { color: #3b82f6; }
        #about-modal .terms { font-size: 0.75rem; max-height: 100px; overflow-y: auto; border: 1px solid #e5e7eb; padding: 0.5rem; border-radius: 0.25rem; margin-top: 0.5rem; }
        
        /* Z-index fix for confirmation modal */
        #confirmation-modal {
            z-index: 110;
        }

        /* Fullscreen Data Grid Modal */
        #data-grid-modal .modal-content {
            width: 95vw;
            height: 90vh;
            max-width: none;
            display: flex;
            flex-direction: column;
        }
        #modal-grid-container {
            flex-grow: 1;
            overflow: auto;
            border: 1px solid #e2e8f0;
            border-radius: 0.25rem;
        }

        /* Tooltip Styles */
        #tooltip {
            position: absolute;
            opacity: 0;
            background-color: rgba(0, 0, 0, 0.75);
            color: white;
            padding: 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 30;
        }
        #tooltip.visible { opacity: 1; }
    </style>
</head>
<body>
    <div id="app">
        <aside id="sidebar">
            <div id="sidebar-resizer"></div>
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-900">Mekko Chart Settings</h2>
                <button id="close-sidebar-btn" class="md:hidden p-2 rounded-full hover:bg-gray-200 text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <div class="sidebar-accordion">
                <!-- Data I/O Section -->
                <details open>
                    <summary>Data & Export <span class="accordion-icon">&gt;</span></summary>
                    <div class="accordion-content space-y-3 pt-4">
                        <div class="flex items-center space-x-2">
                            <button id="save-data-btn" class="flex-1 px-4 py-2 text-sm font-medium text-white bg-blue-500 rounded-md hover:bg-blue-600">Save Data</button>
                            <input type="file" id="load-data-input" class="hidden" accept=".json">
                            <label for="load-data-input" class="flex-1 px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 cursor-pointer text-center">Load Data</label>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button id="export-png-btn" class="flex-1 px-4 py-2 text-sm font-medium text-white bg-green-500 rounded-md hover:bg-green-600">Export as PNG</button>
                            <button id="export-svg-btn" class="flex-1 px-4 py-2 text-sm font-medium text-white bg-purple-500 rounded-md hover:bg-purple-600">Export as SVG</button>
                        </div>
                    </div>
                </details>

                <!-- Data Input Section -->
                <details open>
                    <summary class="flex items-center justify-between">
                        <span>Data Input</span>
                        <div class="flex items-center">
                            <button id="maximize-grid-btn" title="Maximize Data Grid" class="p-1 hover:bg-gray-200 rounded-full">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 1v4m0 0h-4m4 0l-5-5"></path></svg>
                            </button>
                            <span class="accordion-icon ml-2">&gt;</span>
                        </div>
                    </summary>
                    <div class="accordion-content space-y-3 pt-4">
                        <div>
                            <label for="row-title-input" class="sidebar-label">Row Title:</label>
                            <input type="text" id="row-title-input" class="sidebar-input" value="Treatment Type">
                        </div>
                        <div>
                            <label for="column-title-input" class="sidebar-label">Column Title:</label>
                            <input type="text" id="column-title-input" class="sidebar-input" value="Severity">
                        </div>
                        <div>
                            <label for="data-title-input" class="sidebar-label">Data Title (for Y-Axis):</label>
                            <input type="text" id="data-title-input" class="sidebar-input" value="Patients">
                        </div>
                        <div id="sidebar-grid-container" class="data-grid-container">
                            <!-- Sidebar grid rendered here -->
                        </div>
                        <button id="transpose-btn" class="w-full px-4 py-2 text-sm font-medium text-white bg-gray-500 rounded-md hover:bg-gray-600">Transpose Table</button>
                    </div>
                </details>

                <!-- Chart Appearance Section -->
                <details>
                    <summary>Chart Appearance <span class="accordion-icon">&gt;</span></summary>
                    <div class="accordion-content space-y-4 pt-4">
                        <div>
                            <label for="chart-title" class="sidebar-label">Chart Title:</label>
                            <input type="text" id="chart-title" class="sidebar-input">
                        </div>
                        <div>
                            <label class="sidebar-label">Theme:</label>
                            <select id="theme-preset" class="sidebar-select">
                                <option value="default">Default</option>
                                <option value="light">Light</option>
                                <option value="grey">Grey</option>
                                <option value="darkGrey">Dark Grey</option>
                                <option value="pitchBlack">Pitch Black</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="background-color" class="sidebar-label">Background:</label>
                                <input type="color" id="background-color" class="w-full h-8 rounded-md border border-gray-300 cursor-pointer">
                            </div>
                             <div>
                                <label for="border-color" class="sidebar-label">Border:</label>
                                <input type="color" id="border-color" class="w-full h-8 rounded-md border border-gray-300 cursor-pointer">
                            </div>
                        </div>
                        <div>
                            <label class="sidebar-label">Segment Color Palette:</label>
                            <select id="segment-color-palette" class="sidebar-select">
                                <option value="default">Default</option>
                                <option value="vibrant">Vibrant</option>
                                <option value="pastel">Pastel</option>
                                <option value="earthy">Earthy</option>
                                <option value="cool">Cool</option>
                                <option value="warm">Warm</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                        <div>
                            <label for="segment-colors" class="sidebar-label">Custom Colors (hex):</label>
                            <input type="text" id="segment-colors" class="sidebar-input" placeholder="#4285F4,#EA4335,...">
                        </div>
                    </div>
                </details>

                <!-- Axes & Grid Section -->
                <details>
                    <summary>Axes & Gridlines <span class="accordion-icon">&gt;</span></summary>
                    <div class="accordion-content space-y-4 pt-4">
                        <div>
                            <label class="sidebar-label">Y-Axis Scale:</label>
                            <div class="flex items-center space-x-4">
                                <label class="flex items-center"><input type="radio" name="y-axis-scale" value="absolute" class="form-radio"><span class="ml-2 text-sm">Absolute</span></label>
                                <label class="flex items-center"><input type="radio" name="y-axis-scale" value="percentage" checked class="form-radio"><span class="ml-2 text-sm">Percentage</span></label>
                            </div>
                        </div>
                        <div class="space-y-2">
                             <label class="sidebar-label">Axis Display:</label>
                             <label class="flex items-center"><input type="checkbox" id="show-x-axis-labels-checkbox" class="form-checkbox"><span class="ml-2 text-sm">X-Axis Labels</span></label>
                             <label class="flex items-center"><input type="checkbox" id="show-y-axis-labels-checkbox" class="form-checkbox"><span class="ml-2 text-sm">Y-Axis Labels</span></label>
                             <label class="flex items-center"><input type="checkbox" id="show-x-axis-title-checkbox" class="form-checkbox"><span class="ml-2 text-sm">X-Axis Title</span></label>
                             <label class="flex items-center"><input type="checkbox" id="show-y-axis-title-checkbox" class="form-checkbox"><span class="ml-2 text-sm">Y-Axis Title</span></label>
                        </div>
                        <div class="space-y-2">
                            <label class="sidebar-label">Gridlines:</label>
                            <label class="flex items-center"><input type="checkbox" id="show-gridlines" class="form-checkbox"><span class="ml-2 text-sm">Show Y-Axis Gridlines</span></label>
                            <div>
                                <label for="y-axis-ticks" class="sidebar-label text-sm">Gridline Count:</label>
                                <input type="number" id="y-axis-ticks" class="sidebar-input" value="5" min="1" max="20">
                            </div>
                        </div>
                    </div>
                </details>

                <!-- Labels & Legend Section -->
                <details>
                    <summary>Labels & Legend <span class="accordion-icon">&gt;</span></summary>
                    <div class="accordion-content space-y-4 pt-4">
                         <div class="space-y-2">
                            <label class="sidebar-label">Column Labels (X-Axis):</label>
                            <label class="flex items-center"><input type="checkbox" id="show-column-totals" class="form-checkbox"><span class="ml-2 text-sm">Show Column Totals</span></label>
                            <label class="flex items-center"><input type="checkbox" id="abbreviate-totals-checkbox" class="form-checkbox"><span class="ml-2 text-sm">Abbreviate Totals (k, m, b)</span></label>
                        </div>
                        <div class="space-y-2">
                            <label class="sidebar-label">Segment Data Labels:</label>
                            <label class="flex items-center"><input type="checkbox" id="show-data-labels" class="form-checkbox"><span class="ml-2 text-sm">Show Data Labels</span></label>
                             <div>
                                <label for="label-precision" class="sidebar-label text-sm">Decimal Places:</label>
                                <input type="number" id="label-precision" class="sidebar-input" value="0" min="0" max="5">
                            </div>
                        </div>
                        <div>
                            <label class="sidebar-label">Font:</label>
                            <div class="grid grid-cols-2 gap-2">
                                <select id="font-family" class="sidebar-select">
                                    <option>Lato, sans-serif</option>
                                    <option>Inter, sans-serif</option>
                                    <option>Arial, sans-serif</option>
                                    <option>Verdana, sans-serif</option>
                                </select>
                                <input type="number" id="font-size" class="sidebar-input" value="12" min="8" max="30">
                                <input type="color" id="font-color" class="w-full h-8 rounded-md border border-gray-300 cursor-pointer col-span-2">
                            </div>
                        </div>
                        <div>
                            <label class="sidebar-label">Legend Placement:</label>
                            <select id="legend-placement" class="sidebar-select">
                                <option value="right">Right of Chart</option>
                                <option value="below">Below Chart</option>
                                <option value="above">Above Chart</option>
                            </select>
                        </div>
                    </div>
                </details>
            </div>
        </aside>

        <main id="chart-container">
            <button id="toggle-sidebar-btn">
                <span id="toggle-icon"></span>
            </button>
            <svg id="mekko-chart"></svg>
        </main>
    </div>
    
    <footer id="app-footer">
        <a href="https://mekko-chart-app-public.vercel.app/" target="_blank">Quick Mekko Chart</a>
        <span id="info-icon" title="About this App">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
        </span>
    </footer>

    <div id="tooltip"></div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-message"></h3>
            <div class="modal-buttons">
                <button id="modal-yes-btn" class="modal-button confirm">Yes</button>
                <button id="modal-no-btn" class="modal-button cancel">No</button>
            </div>
        </div>
    </div>

    <!-- About Modal -->
    <div id="about-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" id="about-modal-close-btn">
                 <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h3>About Quick Mekko Chart</h3>
            <p>A simple, powerful tool for creating Mekko charts directly in your browser.</p>
            
            <h4>Author</h4>
            <p>Andrius Varanavicius</p>

            <h4>Web Address</h4>
            <p><a href="https://mekko-chart-app-public.vercel.app/" target="_blank">mekko-chart-app-public.vercel.app</a></p>

            <h4>Feedback</h4>
            <p>Have suggestions? <a href="mailto:a.varanavicius@gmail.com?subject=Mekko%20Chart%20App%20Feedback">Send feedback</a>.</p>

            <h4>Terms of Use</h4>
            <div class="terms">
                <p>This application is provided "as is", without warranty of any kind. By using this app, you agree to not hold the author liable for any damages or issues arising from its use.</p>
            </div>
        </div>
    </div>

    <!-- Fullscreen Data Grid Modal -->
    <div id="data-grid-modal" class="modal-overlay">
        <div class="modal-content">
             <button class="modal-close-btn" id="data-grid-modal-close-btn">
                 <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h3 class="text-left">Data Grid</h3>
            <div id="modal-grid-container" class="data-grid-container">
                <!-- Cloned grid will be inserted here -->
            </div>
        </div>
    </div>


    <script>
        // Global variables
        const margin = { top: 60, right: 40, bottom: 100, left: 80 };
        let width, height;

        const defaultData = {
            columnLabels: ['Mild', 'Moderate', 'Severe', 'Critical', 'Asymptomatic'],
            rowLabels: ['Topicals', 'Vitamin D', 'Phototherapy', 'Oral', 'Biological'],
            values: [
                [500000, 200000, 100000, 5000, 1000],
                [1000000, 300000, 200000, 10000, 2000],
                [200000, 100000, 50000, 2500, 500],
                [0, 50000, 10000, 500, 100],
                [0, 10000, 100000, 50000, 20000]
            ]
        };

        const defaultChartConfig = {
            chartTitle: 'Treatment Efficacy',
            yAxisScaleType: 'percentage', 
            backgroundColor: '#FFFFFF',
            borderColor: '#E2E8F0',
            segmentColors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#7B1FA2', '#00796B', '#D32F2F', '#C2185B'],
            fontFamily: 'Lato, sans-serif', 
            fontSize: 12,
            fontColor: '#475569',
            showDataLabels: true,
            labelPrecision: 0,
            showGridlines: false, 
            yAxisTicks: 5,
            showColumnTotals: false,
            abbreviateTotals: false, 
            legendPlacement: 'right',
            showXAxisLabels: true,
            showYAxisLabels: true,
            showXAxisTitle: true,
            showYAxisTitle: true
        };

        const themes = {
            default: { backgroundColor: '#FFFFFF', borderColor: '#E2E8F0', fontColor: '#475569', segmentColors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#7B1FA2', '#00796B', '#D32F2F', '#C2185B'] },
            light: { backgroundColor: '#f8fafc', borderColor: '#e2e8f0', fontColor: '#1e293b', segmentColors: ['#6366f1', '#a855f7', '#ec4899', '#f97316', '#eab308', '#22c55e', '#06b6d4', '#3b82f6'] },
            grey: { backgroundColor: '#e5e7eb', borderColor: '#9ca3af', fontColor: '#374151', segmentColors: ['#6b7280', '#9ca3af', '#d1d5db', '#e5e7eb', '#4b5563', '#1f2937'] },
            darkGrey: { backgroundColor: '#1f2937', borderColor: '#4b5563', fontColor: '#f9fafb', segmentColors: ['#3b82f6', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#ef4444', '#6b7280', '#9ca3af'] },
            pitchBlack: { backgroundColor: '#000000', borderColor: '#374151', fontColor: '#f9fafb', segmentColors: ['#a78bfa', '#f472b6', '#fbbf24', '#4ade80', '#60a5fa', '#ef4444', '#9ca3af', '#e5e7eb'] }
        };

        const palettes = {
            default: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#7B1FA2', '#00796B', '#D32F2F', '#C2185B'],
            vibrant: ['#FF6F61', '#6B5B95', '#88B04B', '#F7CAC9', '#92A8CD', '#F4D03F', '#5B5EA6', '#9B2335'],
            pastel: ['#A8DADC', '#457B9D', '#1D3557', '#F4A261', '#E76F51', '#2A9D8F', '#F8EDEB', '#FCD5CE'],
            earthy: ['#6D597A', '#B5838D', '#E5989B', '#FFB4A2', '#FFCDB2', '#A2D2FF', '#83C5BE', '#006D77'],
            cool: ['#264653', '#2A9D8F', '#E9C46A', '#F4A261', '#E76F51', '#5DADE2', '#A9CCE3', '#D6EAF8'],
            warm: ['#D87B6A', '#F2AE72', '#F8D49D', '#F9E795', '#FAD7A0', '#EB984E', '#E67E22', '#BA4A00']
        };

        let chartData = JSON.parse(JSON.stringify(defaultData));
        let chartConfig = JSON.parse(JSON.stringify(defaultChartConfig));
        
        // DOM Elements
        const sidebar = document.getElementById('sidebar');
        const chartContainer = document.getElementById('chart-container');
        const chartSvg = d3.select('#mekko-chart');
        const tooltip = d3.select('#tooltip');
        
        // Modal elements
        const confirmationModal = document.getElementById('confirmation-modal');
        const aboutModal = document.getElementById('about-modal');
        const dataGridModal = document.getElementById('data-grid-modal');
        let modalOnConfirmCallback = null;

        /**
         * Shows a modal.
         * @param {HTMLElement} modalEl - The modal element to show.
         */
        function showModal(modalEl) {
            modalEl.classList.add('visible');
        }

        /**
         * Hides a modal.
         * @param {HTMLElement} modalEl - The modal element to hide.
         */
        function hideModal(modalEl) {
            modalEl.classList.remove('visible');
        }
        
        function showConfirmationModal(message, onConfirm) {
            document.getElementById('modal-message').textContent = message;
            modalOnConfirmCallback = onConfirm;
            showModal(confirmationModal);
        }

        /**
         * Determines contrasting text color for a given background color.
         */
        function getContrastingTextColor(color) {
            const d3Color = d3.color(color);
            if (!d3Color) return '#333333';
            const luma = 0.299 * d3Color.r + 0.587 * d3Color.g + 0.114 * d3Color.b;
            return luma < 128 ? '#FFFFFF' : '#333333';
        }

        /**
         * Renders the data grid into a specified container.
         * @param {string} containerId - The ID of the container for the grid table.
         */
        function renderDataGrid(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            // Clear previous grid and create a new table
            container.innerHTML = '';
            const table = document.createElement('table');
            table.className = 'data-grid';
            table.innerHTML = `<thead><tr id="${containerId}-col-headers"><th></th></tr></thead><tbody id="${containerId}-data-rows"></tbody>`;
            container.appendChild(table);

            const columnHeadersRow = document.getElementById(`${containerId}-col-headers`);
            const dataRowsBody = document.getElementById(`${containerId}-data-rows`);

            chartData.columnLabels.forEach((label, colIndex) => {
                const th = document.createElement('th');
                th.innerHTML = `<div class="flex items-center justify-center gap-1"><button class="table-action-button add-col-btn" data-col-index="${colIndex}">+</button><input type="text" value="${label}" data-col-index="${colIndex}" class="column-label-input"><button class="table-action-button remove-col-btn" data-col-index="${colIndex}">-</button></div>`;
                columnHeadersRow.appendChild(th);
            });

            chartData.values.forEach((rowValues, rowIndex) => {
                const tr = document.createElement('tr');
                const th = document.createElement('th');
                th.innerHTML = `<div class="flex items-center justify-center gap-1"><button class="table-action-button add-row-btn" data-row-index="${rowIndex}">+</button><input type="text" value="${chartData.rowLabels[rowIndex]}" data-row-index="${rowIndex}" class="row-label-input"><button class="table-action-button remove-row-btn" data-row-index="${rowIndex}">-</button></div>`;
                tr.appendChild(th);
                rowValues.forEach((value, colIndex) => {
                    const td = document.createElement('td');
                    td.innerHTML = `<input type="number" value="${value}" data-row-index="${rowIndex}" data-col-index="${colIndex}" class="data-value-input">`;
                    tr.appendChild(td);
                });
                dataRowsBody.appendChild(tr);
            });
            addGridEventListeners(containerId);
        }


        /**
         * Attaches event listeners to the data grid inputs and buttons.
         * @param {string} containerId - The ID of the grid's container.
         */
        function addGridEventListeners(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            const updateAndRedraw = (action) => { action(); drawMekkoChart(); };
            
            container.querySelectorAll('.column-label-input').forEach(input => input.oninput = (e) => updateAndRedraw(() => chartData.columnLabels[e.target.dataset.colIndex] = e.target.value));
            container.querySelectorAll('.row-label-input').forEach(input => input.oninput = (e) => updateAndRedraw(() => chartData.rowLabels[e.target.dataset.rowIndex] = e.target.value));
            container.querySelectorAll('.data-value-input').forEach(input => input.oninput = (e) => updateAndRedraw(() => chartData.values[e.target.dataset.rowIndex][e.target.dataset.colIndex] = parseFloat(e.target.value) || 0));
            
            const reRenderGrids = () => {
                renderDataGrid('sidebar-grid-container');
                if (dataGridModal.classList.contains('visible')) {
                    renderDataGrid('modal-grid-container');
                }
                drawMekkoChart();
            };

            const addRow = (atIndex) => {
                const newRow = Array(chartData.columnLabels.length).fill(0);
                chartData.rowLabels.splice(atIndex + 1, 0, `Segment ${chartData.rowLabels.length + 1}`);
                chartData.values.splice(atIndex + 1, 0, newRow);
                reRenderGrids();
            };
            const removeRow = (atIndex) => {
                if (chartData.rowLabels.length > 1) {
                    chartData.rowLabels.splice(atIndex, 1);
                    chartData.values.splice(atIndex, 1);
                    reRenderGrids();
                }
            };
            const addColumn = (atIndex) => {
                chartData.columnLabels.splice(atIndex + 1, 0, `Category ${chartData.columnLabels.length + 1}`);
                chartData.values.forEach(row => row.splice(atIndex + 1, 0, 0));
                reRenderGrids();
            };
            const removeColumn = (atIndex) => {
                if (chartData.columnLabels.length > 1) {
                    chartData.columnLabels.splice(atIndex, 1);
                    chartData.values.forEach(row => row.splice(atIndex, 1));
                    reRenderGrids();
                }
            };

            container.querySelectorAll('.add-col-btn').forEach(b => b.onclick = (e) => addColumn(parseInt(e.target.dataset.colIndex)));
            container.querySelectorAll('.remove-col-btn').forEach(b => b.onclick = (e) => showConfirmationModal(`Remove column "${chartData.columnLabels[e.target.dataset.colIndex]}"?`, () => removeColumn(parseInt(e.target.dataset.colIndex))));
            container.querySelectorAll('.add-row-btn').forEach(b => b.onclick = (e) => addRow(parseInt(e.target.dataset.rowIndex)));
            container.querySelectorAll('.remove-row-btn').forEach(b => b.onclick = (e) => showConfirmationModal(`Remove row "${chartData.rowLabels[e.target.dataset.rowIndex]}"?`, () => removeRow(parseInt(e.target.dataset.rowIndex))));
        }

        /**
         * Initializes all configuration inputs with current chartConfig values.
         */
        function initializeConfigInputs() {
            const configMap = {
                'chart-title': 'chartTitle', 'background-color': 'backgroundColor', 'border-color': 'borderColor',
                'font-family': 'fontFamily', 'font-size': 'fontSize', 'font-color': 'fontColor',
                'label-precision': 'labelPrecision', 'y-axis-ticks': 'yAxisTicks', 'legend-placement': 'legendPlacement',
                'show-data-labels': 'showDataLabels', 'show-gridlines': 'showGridlines', 'show-column-totals': 'showColumnTotals',
                'abbreviate-totals-checkbox': 'abbreviateTotals', 'show-x-axis-labels-checkbox': 'showXAxisLabels',
                'show-y-axis-labels-checkbox': 'showYAxisLabels', 'show-x-axis-title-checkbox': 'showXAxisTitle',
                'show-y-axis-title-checkbox': 'showYAxisTitle'
            };

            Object.entries(configMap).forEach(([id, key]) => {
                const el = document.getElementById(id);
                if (el.type === 'checkbox') el.checked = chartConfig[key];
                else el.value = chartConfig[key];
            });

            document.querySelector(`input[name="y-axis-scale"][value="${chartConfig.yAxisScaleType}"]`).checked = true;
            document.getElementById('segment-colors').value = chartConfig.segmentColors.join(',');
        }

        /**
         * Main function to draw the Mekko chart.
         */
        function drawMekkoChart() {
            const containerRect = chartContainer.getBoundingClientRect();
            let currentSvgWidth = containerRect.width;
            let currentSvgHeight = containerRect.height;
            const fs = chartConfig.fontSize;

            let chartContentMargin = { ...margin };
            
            const legendRectSize = 12, legendTextOffset = 17, legendLineHeight = fs * 1.5, legendPadding = 10;
            if (chartData.rowLabels.length > 0 && chartConfig.legendPlacement !== 'none') {
                const estimateTextWidth = text => text.length * (fs * 0.6); 
                if (chartConfig.legendPlacement === 'right') {
                    const maxTextWidth = d3.max(chartData.rowLabels, d => estimateTextWidth(d));
                    chartContentMargin.right += legendRectSize + legendTextOffset + maxTextWidth + legendPadding;
                } else {
                    const legendHeight = Math.ceil(chartData.rowLabels.length / 5) * legendLineHeight + legendPadding;
                    if (chartConfig.legendPlacement === 'below') chartContentMargin.bottom += legendHeight;
                    else if (chartConfig.legendPlacement === 'above') chartContentMargin.top += legendHeight;
                }
            }
            
            width = Math.max(1, currentSvgWidth - chartContentMargin.left - chartContentMargin.right);
            height = Math.max(1, currentSvgHeight - chartContentMargin.top - chartContentMargin.bottom);

            chartSvg.selectAll('*').remove();
            chartSvg.attr('width', currentSvgWidth).attr('height', currentSvgHeight).style('background-color', chartConfig.backgroundColor);
            const g = chartSvg.append('g').attr('transform', `translate(${chartContentMargin.left},${chartContentMargin.top})`);

            const columnTotals = chartData.columnLabels.map((_, i) => d3.sum(chartData.values, d => d[i]));
            const overallTotal = d3.sum(columnTotals);

            if (overallTotal === 0) {
                g.append("text").attr("x", width/2).attr("y", height/2).attr("text-anchor", "middle").attr("fill", chartConfig.fontColor).text("No data to display.");
                return;
            }

            const x = d3.scaleLinear().domain([0, overallTotal]).range([0, width]);
            const y = chartConfig.yAxisScaleType === 'percentage' 
                ? d3.scaleLinear().domain([0, 1]).range([height, 0])
                : d3.scaleLinear().domain([0, d3.max(columnTotals) || 1]).range([height, 0]).nice(); // Use .nice() for better scaling

            const color = d3.scaleOrdinal(chartConfig.segmentColors).domain(chartData.rowLabels);

            let currentX = 0;
            const chartDataProcessed = chartData.columnLabels.map((colLabel, i) => {
                const colTotal = columnTotals[i];
                const colWidth = x(colTotal);
                let accumulatedY = 0;
                const segments = chartData.rowLabels.map((rowLabel, j) => {
                    const value = chartData.values[j][i];
                    const segment = {
                        value: value, x: currentX, width: colWidth, color: color(rowLabel),
                        rowLabel: rowLabel, colLabel: colLabel
                    };
                    if (chartConfig.yAxisScaleType === 'percentage') {
                        segment.height = colTotal > 0 ? (value / colTotal) * height : 0;
                        segment.y = height - accumulatedY - segment.height;
                        segment.displayValue = colTotal > 0 ? (value / colTotal) * 100 : 0;
                    } else {
                        segment.y = y(accumulatedY + value);
                        segment.height = y(accumulatedY) - y(accumulatedY + value);
                        segment.displayValue = value;
                    }
                    accumulatedY += segment.height;
                    return segment;
                });
                const columnData = { column: colLabel, segments: segments, x: currentX + colWidth / 2, total: colTotal };
                currentX += colWidth;
                return columnData;
            });

            // Draw segments with tooltips
            g.selectAll('.column-group').data(chartDataProcessed).enter().append('g')
                .each(function(d) {
                    d3.select(this).selectAll('rect').data(d.segments).enter().append('rect')
                        .attr('x', s => s.x).attr('y', s => s.y).attr('width', s => s.width).attr('height', s => s.height)
                        .attr('fill', s => s.color).attr('stroke', chartConfig.borderColor).attr('stroke-width', 1.5).attr('rx', 4)
                        .on('mouseover', (event, s) => {
                            tooltip.classed('visible', true);
                            let valueText = chartConfig.yAxisScaleType === 'percentage' ? `${s.displayValue.toFixed(chartConfig.labelPrecision)}%` : s.value.toLocaleString();
                            tooltip.html(`<strong>${s.colLabel}</strong><br>${s.rowLabel}: ${valueText}`);
                        })
                        .on('mousemove', (event) => tooltip.style('left', (event.pageX + 15) + 'px').style('top', (event.pageY - 28) + 'px'))
                        .on('mouseout', () => tooltip.classed('visible', false));
                    
                    if(chartConfig.showDataLabels) {
                        d3.select(this).selectAll('.segment-label').data(d.segments).enter().append('text')
                            .attr('class', 'segment-label').attr('x', s => s.x + s.width/2).attr('y', s => s.y + s.height/2).attr('dy', '0.35em')
                            .attr('font-family', chartConfig.fontFamily).attr('font-size', `${fs * 0.9}px`).attr('fill', s => getContrastingTextColor(s.color))
                            .text(s => (s.width > 20 && s.height > 15 && s.displayValue !== 0) ? `${s.displayValue.toFixed(chartConfig.labelPrecision)}${chartConfig.yAxisScaleType === 'percentage' ? '%' : ''}`: '');
                    }
                });
            
            // X-Axis Labels with force simulation
            if (chartConfig.showXAxisLabels) {
                const labelNodes = chartDataProcessed.map((d, i) => {
                    let totalStr = chartConfig.showColumnTotals ? ` (${chartConfig.abbreviateTotals ? d3.format(".2s")(d.total).replace(/G/,'B') : d.total.toLocaleString()})` : '';
                    return { index: i, fx: d.x, text: `${d.column}${totalStr}`, sourceX: d.x };
                });

                const simulation = d3.forceSimulation(labelNodes)
                    .force("collide", d3.forceCollide(d => d.text.length * fs * 0.3 + 10))
                    .force("x", d3.forceX(d => d.fx).strength(1))
                    .stop();
                for (let i = 0; i < 150; ++i) simulation.tick();

                labelNodes.forEach((node, i) => {
                    node.y = height + fs * (i % 2 === 0 ? 2.5 : 4.5);
                });

                const labelGroup = g.append('g').attr('class', 'x-axis-labels');
                labelGroup.selectAll('.leader-line').data(labelNodes).enter().append('line')
                    .attr('class', 'leader-line').attr('x1', d => d.sourceX).attr('y1', height).attr('x2', d => d.x).attr('y2', d => d.y - fs * 0.7).attr('stroke', chartConfig.fontColor);
                labelGroup.selectAll('.column-label').data(labelNodes).enter().append('text')
                    .attr('class', 'column-label').attr('x', d => d.x).attr('y', d => d.y).attr('font-family', chartConfig.fontFamily).attr('font-size', `${fs}px`).attr('fill', chartConfig.fontColor).text(d => d.text);
            }

            // Titles
            chartSvg.append('text').attr('class', 'chart-title').attr('x', chartContentMargin.left + width/2).attr('y', chartContentMargin.top / 2).attr('font-family', chartConfig.fontFamily).attr('font-size', `${fs * 1.8}px`).attr('fill', chartConfig.fontColor).text(chartConfig.chartTitle);
            if (chartConfig.showYAxisTitle) {
                g.append('text').attr('class', 'axis-title').attr('transform', 'rotate(-90)').attr('y', -chartContentMargin.left * 0.75).attr('x', -height/2).attr('font-family', chartConfig.fontFamily).attr('font-size', `${fs*1.2}px`).attr('fill', chartConfig.fontColor).text(document.getElementById('data-title-input').value || 'Value');
            }
            if (chartConfig.showXAxisTitle) {
                g.append('text').attr('class', 'axis-title').attr('x', width/2).attr('y', height + chartContentMargin.bottom * 0.9).attr('font-family', chartConfig.fontFamily).attr('font-size', `${fs*1.2}px`).attr('fill', chartConfig.fontColor).text(document.getElementById('column-title-input').value);
            }

            // Axes and Grid
            if (chartConfig.showYAxisLabels) {
                const yAxis = d3.axisLeft(y).ticks(chartConfig.yAxisTicks).tickFormat(d => chartConfig.yAxisScaleType === 'percentage' ? `${d * 100}%` : d3.format(".2s")(d).replace(/G/,'B'));
                g.append('g').attr('class', 'axis y-axis').call(yAxis).selectAll("text").attr("fill", chartConfig.fontColor).attr("font-family", chartConfig.fontFamily).attr("font-size", `${fs}px`);
            }
            if (chartConfig.showGridlines) {
                g.append("g").attr("class", "grid y-grid").call(d3.axisLeft(y).ticks(chartConfig.yAxisTicks).tickSize(-width).tickFormat(""));
            }

            // Legend
            const legend = chartSvg.append('g').attr('class', 'legend').attr('font-family', chartConfig.fontFamily).attr('font-size', `${fs * 0.9}px`).attr('fill', chartConfig.fontColor);
            const legendItems = legend.selectAll('.legend-item').data(chartData.rowLabels).enter().append('g').attr('class', 'legend-item');
            legendItems.append('rect').attr('width', legendRectSize).attr('height', legendRectSize).attr('fill', d => color(d)).attr('stroke', chartConfig.borderColor);
            legendItems.append('text').attr('x', legendTextOffset).attr('y', legendRectSize/2).attr('dy', '0.35em').text(d => d);
            if (chartConfig.legendPlacement === 'right') {
                legendItems.attr('transform', (d, i) => `translate(${chartContentMargin.left + width + legendPadding}, ${chartContentMargin.top + i * legendLineHeight})`);
            } else {
                let xPos = chartContentMargin.left, yPos;
                if(chartConfig.legendPlacement === 'below') yPos = chartContentMargin.top + height + chartContentMargin.bottom * 0.8;
                else yPos = chartContentMargin.top - legendCalculatedHeight - legendPadding;
                const availableWidth = currentSvgWidth - chartContentMargin.left - chartContentMargin.right;
                legendItems.attr('transform', function() {
                    const itemWidth = this.getBBox().width + 20;
                    if (xPos + itemWidth > chartContentMargin.left + availableWidth) {
                        xPos = chartContentMargin.left; yPos += legendLineHeight;
                    }
                    const transform = `translate(${xPos}, ${yPos})`;
                    xPos += itemWidth;
                    return transform;
                });
            }
        }

        /**
         * Sets up all event listeners for the application.
         */
        function setupEventListeners() {
            // Sidebar toggle
            document.getElementById('toggle-sidebar-btn').addEventListener('click', () => {
                sidebar.classList.toggle('hidden');
                setTimeout(drawMekkoChart, 300);
            });
            document.getElementById('close-sidebar-btn').addEventListener('click', () => sidebar.classList.add('hidden'));

            // Sidebar resize
            let isResizing = false;
            document.getElementById('sidebar-resizer').addEventListener('mousedown', () => { isResizing = true; document.body.style.cursor = 'ew-resize'; });
            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;
                sidebar.style.width = `${Math.max(280, e.clientX)}px`;
                drawMekkoChart();
            });
            document.addEventListener('mouseup', () => { isResizing = false; document.body.style.cursor = ''; });

            // Data I/O
            document.getElementById('save-data-btn').addEventListener('click', () => {
                const state = { chartData, chartConfig, dataTitles: { row: document.getElementById('row-title-input').value, column: document.getElementById('column-title-input').value, data: document.getElementById('data-title-input').value } };
                const blob = new Blob([JSON.stringify(state, null, 2)], {type: "application/json"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = 'mekko-chart-data.json'; a.click();
                URL.revokeObjectURL(url);
            });
            document.getElementById('load-data-input').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const state = JSON.parse(event.target.result);
                        if (state.chartData && state.chartConfig && state.dataTitles) {
                            chartData = state.chartData;
                            chartConfig = { ...defaultChartConfig, ...state.chartConfig };
                            document.getElementById('row-title-input').value = state.dataTitles.row;
                            document.getElementById('column-title-input').value = state.dataTitles.column;
                            document.getElementById('data-title-input').value = state.dataTitles.data;
                            renderDataGrid('sidebar-grid-container'); initializeConfigInputs(); drawMekkoChart();
                        } else { showConfirmationModal('Invalid data file format.', () => {}); }
                    } catch (error) { showConfirmationModal('Error reading the data file.', () => {}); }
                };
                reader.readAsText(file);
                e.target.value = '';
            });

            // Export
            document.getElementById('export-png-btn').addEventListener('click', () => {
                document.getElementById('toggle-sidebar-btn').style.display = 'none';
                html2canvas(document.getElementById('chart-container')).then(canvas => {
                    const link = document.createElement('a');
                    link.download = 'mekko-chart.png';
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    document.getElementById('toggle-sidebar-btn').style.display = 'flex';
                });
            });
            document.getElementById('export-svg-btn').addEventListener('click', () => {
                const svgData = new XMLSerializer().serializeToString(document.getElementById('mekko-chart'));
                const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(svgBlob);
                const a = document.createElement('a');
                a.href = url; a.download = 'mekko-chart.svg'; a.click();
                URL.revokeObjectURL(url);
            });

            // Transpose
            document.getElementById('transpose-btn').addEventListener('click', () => {
                const transposedValues = chartData.values[0].map((_, colIndex) => chartData.values.map(row => row[colIndex]));
                [chartData.values, chartData.rowLabels, chartData.columnLabels] = [transposedValues, chartData.columnLabels, chartData.rowLabels];
                const rowTitleEl = document.getElementById('row-title-input');
                const colTitleEl = document.getElementById('column-title-input');
                [rowTitleEl.value, colTitleEl.value] = [colTitleEl.value, rowTitleEl.value];
                renderDataGrid('sidebar-grid-container'); drawMekkoChart();
            });

            // Config inputs
            sidebar.addEventListener('input', (e) => {
                const targetId = e.target.id;
                const targetValue = e.target.type === 'checkbox' ? e.target.checked : e.target.value;

                const configMap = {
                    'chart-title': 'chartTitle', 'background-color': 'backgroundColor', 'border-color': 'borderColor',
                    'font-family': 'fontFamily', 'font-size': 'fontSize', 'font-color': 'fontColor',
                    'label-precision': 'labelPrecision', 'y-axis-ticks': 'yAxisTicks', 'legend-placement': 'legendPlacement',
                    'show-data-labels': 'showDataLabels', 'show-gridlines': 'showGridlines', 'show-column-totals': 'showColumnTotals',
                    'abbreviate-totals-checkbox': 'abbreviateTotals', 'show-x-axis-labels-checkbox': 'showXAxisLabels',
                    'show-y-axis-labels-checkbox': 'showYAxisLabels', 'show-x-axis-title-checkbox': 'showXAxisTitle',
                    'show-y-axis-title-checkbox': 'showYAxisTitle', 'segment-colors': 'segmentColors'
                };
                
                if (configMap[targetId]) {
                    chartConfig[configMap[targetId]] = (configMap[targetId] === 'segmentColors') ? targetValue.split(',').map(c=>c.trim()) : targetValue;
                } else if (targetId === 'theme-preset') {
                    Object.assign(chartConfig, themes[targetValue]);
                    initializeConfigInputs();
                } else if (targetId === 'segment-color-palette') {
                    if (targetValue !== 'custom') {
                        chartConfig.segmentColors = palettes[targetValue];
                        document.getElementById('segment-colors').value = chartConfig.segmentColors.join(',');
                    }
                } else if (e.target.name === 'y-axis-scale') {
                    chartConfig.yAxisScaleType = targetValue;
                }
                drawMekkoChart();
            });

            // Modals
            document.getElementById('modal-yes-btn').addEventListener('click', () => { if (modalOnConfirmCallback) modalOnConfirmCallback(); hideModal(confirmationModal); });
            document.getElementById('modal-no-btn').addEventListener('click', () => hideModal(confirmationModal));
            document.getElementById('info-icon').addEventListener('click', () => showModal(aboutModal));
            document.getElementById('about-modal-close-btn').addEventListener('click', () => hideModal(aboutModal));
            document.getElementById('maximize-grid-btn').addEventListener('click', () => {
                renderDataGrid('modal-grid-container');
                showModal(dataGridModal);
            });
            document.getElementById('data-grid-modal-close-btn').addEventListener('click', () => {
                hideModal(dataGridModal);
                renderDataGrid('sidebar-grid-container'); // Refresh sidebar grid
            });
        }

        // --- Initial Setup ---
        window.onload = () => {
            renderDataGrid('sidebar-grid-container');
            initializeConfigInputs();
            setupEventListeners();
            drawMekkoChart();
        };

        window.addEventListener('resize', drawMekkoChart);

    </script>
</body>
</html>
