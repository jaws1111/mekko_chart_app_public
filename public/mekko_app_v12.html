<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- SEO Metadata -->
    <meta name="description" content="Generate Mekko charts quickly with free tool at mekkochart.vercel.app. Customize colors, formatting, and sizes for data visualizations.">
    <meta name="keywords" content="Mekko chart, chart generator, data visualization, custom charts, free chart tool">
    <meta name="author" content="Andrius Varanavicius">
    <meta name="application-version" content="0.22.0">
    <meta name="robots" content="index, follow">
    <meta property="og:title" content="Mekko Chart Generator - Create Custom Charts">
    <meta property="og:description" content="Easily create and customize Mekko charts with our free online tool at mekkochart.vercel.app. Perfect for data visualization.">
    <meta property="og:image" content="https://mekkochart.vercel.app/images/mekkochart_large.png">
    <meta property="og:url" content="https://mekkochart.vercel.app/">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Mekko Chart Generator - Free Tool">
    <meta name="twitter:description" content="Create custom Mekko charts with ease at mekkochart.vercel.app. Adjust colors and formatting for impactful results.">
    <meta name="twitter:image" content="https://mekkochart.vercel.app/images/mekkochart_large.png">
    <title>Mekko Chart Generator - Create Custom Mekko Charts Easily</title>
    <link rel="canonical" href="https://mekkochart.vercel.app/">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "Mekko Chart Generator",
      "description": "A free online tool to create and customize Mekko charts for data visualization.",
      "applicationCategory": "Data Visualization Tool",
      "operatingSystem": "Web",
      "softwareVersion": "0.22.0",
      "url": "https://mekkochart.vercel.app/",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      }
    }
    </script>
    <!-- End SEO Metadata -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">

    <!-- Firebase SDKs -->
    <script type="module">
        // Import necessary Firebase modules, now including Google Auth
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, collection, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.currentUserId = null;

        // Your Firebase configuration
        const appId = "mekkochartapp";
        const firebaseConfig = {
            apiKey: "AIzaSyA3YYDmmA-Gy3EH--206L2zvOCVSiEVQiE",
            authDomain: "mekkochartapp.firebaseapp.com",
            projectId: "mekkochartapp",
            storageBucket: "mekkochartapp.firebasestorage.app",
            messagingSenderId: "770033353817",
            appId: "1:770033353817:web:fa65f4cf9ad61397b35d48",
            measurementId: "G-G9JS1M5X73"
        };

        if (Object.keys(firebaseConfig).length > 0 && firebaseConfig.apiKey) {
            console.log("✅ Firebase config found. Initializing...");
            window.firebaseApp = initializeApp(firebaseConfig);
            window.db = getFirestore(window.firebaseApp);
            window.auth = getAuth(window.firebaseApp);

            // Function to handle Google Sign-In
            window.signInWithGoogle = async () => {
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(window.auth, provider);
                } catch (error) {
                    console.error("Error signing in with Google:", error);
                    if (error.code !== 'auth/popup-closed-by-user') {
                         if(window.showConfirmationModal) {
                            window.showConfirmationModal(`Google Sign-In Error: ${error.message}`, () => {}, true);
                         } else {
                            alert(`Google Sign-In Error: ${error.message}`);
                         }
                    }
                }
            };

            // Listen for auth state changes to update the UI
            onAuthStateChanged(window.auth, async (user) => {
                const userProfile = document.getElementById('user-profile');
                const userName = document.getElementById('user-name');
                const userPhoto = document.getElementById('user-photo');
                const signInBtn = document.getElementById('sign-in-btn');
                const signOutBtn = document.getElementById('sign-out-btn');
                const userIdDisplay = document.getElementById('user-id-display');
                const saveOnlineBtn = document.getElementById('save-chart-online-btn');
                const loadOnlineBtn = document.getElementById('load-chart-online-btn');
                const onlineButtons = [saveOnlineBtn, loadOnlineBtn];

                if (user) {
                    // User is signed in
                    window.currentUserId = user.uid;
                    console.log("User signed in:", user.uid, user.displayName);

                    userName.textContent = user.displayName || user.email;
                    userPhoto.src = user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName || user.email}&background=random`;
                    userProfile.classList.remove('hidden');
                    signInBtn.classList.add('hidden');
                    signOutBtn.classList.remove('hidden');
                    userIdDisplay.textContent = `UID: ${user.uid}`;

                    onlineButtons.forEach(btn => {
                        btn.disabled = false;
                        btn.classList.remove('opacity-50', 'cursor-not-allowed');
                        btn.title = ''; // Clear tooltip
                    });
                    
                    if(window.loadUserPreferences) await window.loadUserPreferences();

                } else {
                    // User is signed out
                    window.currentUserId = null;
                    console.log("User is signed out.");

                    userProfile.classList.add('hidden');
                    signInBtn.classList.remove('hidden');
                    signOutBtn.classList.add('hidden');
                    userIdDisplay.textContent = "Signed Out";

                    onlineButtons.forEach(btn => {
                        btn.disabled = false; // Keep button enabled to catch click event
                        btn.classList.add('opacity-50', 'cursor-not-allowed'); // Style as disabled
                        btn.title = 'Sign in to use this feature';
                    });
                }
            });

            // Expose signOut function globally
            window.signOutUser = async () => {
                try {
                    await signOut(window.auth);
                    console.log("User signed out successfully.");
                } catch (error) {
                    console.error("Error signing out:", error);
                }
            };

            // Expose Firestore functions globally
            window.firebase = {
                db: window.db,
                auth: window.auth,
                currentUserId: () => window.currentUserId,
                collection, doc, addDoc, getDocs, deleteDoc, getDoc, setDoc,
                appId: appId
            };
        } else {
            console.warn("Firebase config not found. Online features disabled.");
            const userIdDisplay = document.getElementById('user-id-display');
            if(userIdDisplay) userIdDisplay.textContent = `Offline Mode`;
            const signInBtn = document.getElementById('sign-in-btn');
            if(signInBtn) signInBtn.style.display = 'none';
            ['save-chart-online-btn', 'load-chart-online-btn'].forEach(id => {
                const btn = document.getElementById(id);
                if(btn) {
                    btn.disabled = true;
                    btn.title = 'Firebase not configured';
                }
            });
        }
    </script>

    <style>
        :root {
            --sidebar-base-font-size: 14px;
        }

        body {
            font-family: 'Inter', sans-serif;
            /* overflow: hidden; -- REMOVED to fix footer visibility on mobile */
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #f8fafc;
        }

        #app {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
        }

        #sidebar {
            font-size: var(--sidebar-base-font-size);
            width: var(--sidebar-width, 350px);
            min-width: 280px;
            max-width: 50%;
            background-color: #f1f5f9; /* Changed to a slightly different gray */
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease-in-out, width 0.3s ease-in-out;
            transform: translateX(0);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            z-index: 10;
            position: relative;
            overflow: hidden; /* This will clip content when sidebar is collapsed */
        }
        
        #sidebar-content-wrapper {
            overflow-y: auto;
            padding: 0 1rem 1rem 1rem;
            flex-grow: 1;
        }

        #sidebar.hidden {
            transform: translateX(-100%);
            width: 0;
            padding: 0;
            min-width: 0;
        }

        #sidebar-resizer {
            position: absolute;
            top: 0;
            right: 0;
            width: 8px;
            height: 100%;
            cursor: ew-resize;
            z-index: 11;
        }
        #sidebar-resizer:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }

        #chart-container {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #ffffff;
            position: relative;
            overflow: hidden;
            transition: width 0.3s ease-in-out, margin-left 0.3s ease-in-out;
        }

        #toggle-sidebar-btn {
            position: absolute;
            top: 1rem;
            left: 1rem;
            z-index: 20;
            background-color: rgba(203, 213, 225, 0.5);
            color: #475569;
            border-radius: 9999px;
            width: 32px;
            height: 32px;
            padding: 0;
            box-shadow: none;
            border: 1px solid rgba(226, 232, 240, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease-in-out;
        }
        #toggle-sidebar-btn:hover {
            background-color: rgba(148, 163, 184, 0.7);
            color: #1e293b;
        }

        .data-grid-container {
            overflow: auto;
            margin-top: 0.75rem;
        }

        .data-grid {
            width: 100%;
            border-collapse: collapse;
            font-size: inherit;
        }

        .data-grid th, .data-grid td {
            border: 1px solid #e2e8f0;
            padding: 0;
            text-align: center;
            min-width: 80px;
        }

        .data-grid th {
            background-color: #f1f5f9;
            font-weight: 600;
            padding: 0.2rem 0.1rem;
            position: relative;
        }

        .data-grid input[type="text"],
        .data-grid input[type="number"] {
            width: 100%;
            padding: 0.2rem;
            border: none;
            border-radius: 0;
            text-align: center;
            background-color: transparent;
            font-family: 'Inter', sans-serif;
            font-size: inherit;
        }
        
        .data-grid .column-header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2px;
        }
        
        .data-grid .column-controls {
            display: flex;
            flex-direction: column;
            position: absolute;
            right: 1px;
            top: 1px;
        }
        
        .table-action-button, .font-size-control-btn {
            background-color: #e2e8f0;
            border: none;
            color: #475569;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            padding: 0;
        }
        .table-action-button:hover, .font-size-control-btn:hover {
            background-color: #cbd5e1;
        }
        .font-size-control-btn {
            width: 16px; height: 16px;
        }

        .data-grid input[type="number"]::-webkit-inner-spin-button,
        .data-grid input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .data-grid input[type="number"] {
            -moz-appearance: textfield;
        }

        /* D3 chart specific styles */
        .chart-svg { width: 100%; height: 100%; }
        .axis path, .axis line { fill: none; stroke: #cbd5e1; shape-rendering: crispEdges; }
        .grid line { stroke: #e2e8f0; stroke-opacity: 0.7; shape-rendering: crispEdges; }
        .segment-label { text-anchor: middle; pointer-events: none; }
        .column-label { text-anchor: middle; }
        .leader-line { stroke: #9ca3af; stroke-width: 1px; stroke-dasharray: 2,2; }
        .chart-title { font-weight: 700; text-anchor: middle; }
        .axis-title { font-weight: 600; text-anchor: middle; }
        .legend-item { cursor: pointer; }
        .legend-title { font-weight: bold; }
        
        .horizontal-drag-handle {
            cursor: ew-resize;
            fill: rgba(0,0,0,0.05);
            transition: fill 0.2s;
        }
        .horizontal-drag-handle:hover {
            fill: rgba(0,0,0,0.2);
        }
        .vertical-drag-handle {
            cursor: ns-resize;
            fill: rgba(0,0,0,0.05);
            transition: fill 0.2s;
        }
        .vertical-drag-handle:hover {
            fill: rgba(0,0,0,0.2);
        }
        
        .sidebar-accordion details {
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            margin-bottom: 0.1rem;
            background-color: #ffffff;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .sidebar-accordion summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.7rem;
            font-weight: 600;
            cursor: pointer;
            list-style: none;
        }
        .sidebar-accordion summary::-webkit-details-marker { display: none; }
        .sidebar-accordion summary .accordion-icon { transition: transform 0.2s; }
        .sidebar-accordion details[open] summary .accordion-icon { transform: rotate(90deg); }
        .sidebar-accordion .accordion-content { padding: 0 0.7rem 0.7rem 0.7rem; border-top: 1px solid #e2e8f0; }
        .sidebar-label { font-size: inherit; margin-bottom: 0.25rem; display: block; }
        .sidebar-input, .sidebar-select {
            padding: 0.375rem;
            font-size: inherit;
            width: 100%;
            border-radius: 0.375rem;
            border: 1px solid #cbd5e1;
        }
        
        .font-size-input-wrapper {
            position: relative;
        }
        .font-size-input-wrapper .font-size-controls {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        @media (max-width: 768px) {
            #sidebar { position: absolute; height: 100%; left: 0; top: 0; --sidebar-width: 100vw; }
            #sidebar.hidden { transform: translateX(-100%); }
            #sidebar:not(.hidden) { transform: translateX(0); }
            #toggle-sidebar-btn { left: 1rem; right: auto; top: 1rem; transform: translateX(0); }
            #chart-container { width: 100%; }
            #sidebar-resizer { display: none; }
        }

        #app-footer {
            flex-shrink: 0;
            padding: 0.5rem 1rem;
            text-align: center;
            font-size: 0.8rem;
            color: #64748b;
            background-color: #f8fafc;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            width: 100%;
        }
        #app-footer a { color: #3b82f6; text-decoration: none; font-weight: 500; }
        #app-footer a:hover { text-decoration: underline; }
        #info-icon, #feedback-icon { cursor: pointer; color: #9ca3af; }
        #info-icon:hover, #feedback-icon:hover { color: #4b5563; }
        
        #auth-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
        }
        #user-profile.hidden, #sign-in-btn.hidden, #sign-out-btn.hidden {
            display: none;
        }
        #user-profile {
             display: flex;
             align-items: center;
             gap: 0.75rem;
             width: 100%;
             padding: 0.5rem;
             background-color: #e2e8f0;
             border-radius: 0.375rem;
        }
        #user-id-display {
            font-size: 0.75rem;
            color: #64748b;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 250px;
            text-align: center;
            padding-top: 0.5rem;
            margin-top: 0.5rem;
        }
        #sign-in-btn, #sign-out-btn {
            width: 100%;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        #sign-in-btn {
            background-color: #4285F4;
            color: white;
        }
        #sign-in-btn:hover {
            background-color: #3367D6;
        }
        #sign-out-btn {
            background-color: #ef4444;
            color: white;
            font-size: 0.875rem;
        }
        #sign-out-btn:hover {
            background-color: #dc2626;
        }


        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            text-align: center;
            max-width: 90%;
            width: 550px;
            font-family: 'Inter', sans-serif;
            color: #1e293b;
            position: relative;
            transform: scale(0.95);
            transition: transform 0.3s;
        }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-content h3 { font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; }
        .modal-buttons { display: flex; justify-content: center; gap: 1rem; margin-top: 1.5rem; }
        .modal-button { padding: 0.5rem 1.25rem; border-radius: 0.375rem; font-weight: 500; cursor: pointer; transition: background-color 0.2s, border-color 0.2s; }
        .modal-button.confirm { background-color: #ef4444; color: white; border: 1px solid #ef4444; }
        .modal-button.confirm:hover { background-color: #dc2626; }
        .modal-button.cancel { background-color: #f1f5f9; color: #334155; border: 1px solid #cbd5e1; }
        .modal-button.cancel:hover { background-color: #e2e8f0; }
        .modal-close-btn { position: absolute; top: 0.75rem; right: 0.75rem; background: none; border: none; cursor: pointer; color: #9ca3af; }
        .modal-close-btn:hover { color: #4b5563; }
        #about-modal .modal-content { text-align: left; }
        #about-modal h4 { font-weight: 600; margin-top: 1rem; margin-bottom: 0.5rem; }
        #about-modal p, #about-modal a { font-size: 0.875rem; color: #475569; }
        #about-modal a { color: #3b82f6; }
        #about-modal .terms { font-size: 0.75rem; max-height: 100px; overflow-y: auto; border: 1px solid #e5e7eb; padding: 0.5rem; border-radius: 0.25rem; margin-top: 0.5rem; }
        
        #confirmation-modal, #feedback-modal, #save-chart-modal { z-index: 110; }
        #data-grid-modal, #load-chart-modal { z-index: 105; }

        #data-grid-modal .modal-content, #feedback-modal .modal-content, #load-chart-modal .modal-content {
            width: 95vw;
            height: 90vh;
            max-width: none;
            display: flex;
            flex-direction: column;
        }
        #modal-grid-container, #feedback-iframe, #saved-charts-list {
            flex-grow: 1;
            overflow: auto;
            border: 1px solid #e2e8f0;
            border-radius: 0.25rem;
            padding: 0.5rem;
        }
        #saved-charts-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #saved-charts-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid #e2e8f0;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #saved-charts-list li:hover {
            background-color: #f1f5f9;
        }
        #saved-charts-list li:last-child {
            border-bottom: none;
        }
        #saved-charts-list .chart-info {
            flex-grow: 1;
            text-align: left;
        }
        #saved-charts-list .chart-name {
            font-weight: 600;
            color: #1e293b;
        }
        #saved-charts-list .chart-date {
            font-size: 0.85rem;
            color: #64748b;
        }
        #saved-charts-list .chart-actions button {
            background: none;
            border: none;
            cursor: pointer;
            color: #ef4444;
            margin-left: 0.5rem;
            padding: 0.25rem;
            border-radius: 0.25rem;
        }
        #saved-charts-list .chart-actions button:hover {
            background-color: #fee2e2;
        }
        #chart-name-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #cbd5e1;
            border-radius: 0.375rem;
            margin-top: 0.5rem;
        }
        #loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            z-index: 120;
            display: none; /* Hidden by default */
        }


        #tooltip {
            position: absolute;
            opacity: 0;
            background-color: rgba(0, 0, 0, 0.75);
            color: white;
            padding: 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 30;
        }
        #tooltip.visible { opacity: 1; }

        #visual-edit-toggle.active {
            background-color: #3b82f6;
            color: white;
        }
        
        /* Tab Styles */
        .tab-btn {
            padding: 0.75rem 1rem;
            font-weight: 600;
            color: #6b7280; /* text-gray-500 */
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
            cursor: pointer;
            background: none;
            border-top: none;
            border-left: none;
            border-right: none;
        }
        .tab-btn.active {
            color: #4f46e5; /* indigo-600 */
            border-color: #4f46e5;
        }
        .tab-content.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div id="app">
        <aside id="sidebar">
            <div id="sidebar-resizer"></div>
            
            <!-- TABS -->
            <div class="flex border-b border-gray-300 px-4 bg-white">
                <button data-tab="settings" class="tab-btn active">Settings</button>
                <button data-tab="account" class="tab-btn">Account</button>
            </div>

            <div id="sidebar-content-wrapper">
                <!-- SETTINGS TAB CONTENT -->
                <div id="settings-tab-content" class="tab-content">
                    <div class="flex justify-between items-center pt-4 pb-2">
                        <h2 class="text-lg font-bold text-gray-900">Chart Controls</h2>
                        <div class="flex items-center gap-2">
                            <button id="decrease-sidebar-font" class="p-1 rounded-full hover:bg-gray-300 text-gray-600 font-bold">-</button>
                            <button id="increase-sidebar-font" class="p-1 rounded-full hover:bg-gray-300 text-gray-600 font-bold">+</button>
                            <button id="close-sidebar-btn" class="md:hidden p-2 rounded-full hover:bg-gray-300 text-gray-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                    </div>

                    <div class="sidebar-accordion">
                        <!-- Data I/O Section -->
                        <details open>
                            <summary>Data & Export <span class="accordion-icon">&gt;</span></summary>
                            <div class="accordion-content space-y-3 pt-4">
                                <div class="flex items-center space-x-2">
                                    <button id="save-data-btn" class="flex-1 px-4 py-2 text-sm font-medium text-gray-700 bg-indigo-200 rounded-md hover:bg-indigo-300">Save Data (Local)</button>
                                    <input type="file" id="load-data-input" class="hidden" accept=".json">
                                    <label for="load-data-input" class="flex-1 px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 cursor-pointer text-center">Load Data (Local)</label>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button id="save-chart-online-btn" class="flex-1 px-4 py-2 text-sm font-medium text-white bg-indigo-500 rounded-md hover:bg-indigo-600 transition-all">Save Chart (Online)</button>
                                    <button id="load-chart-online-btn" class="flex-1 px-4 py-2 text-sm font-medium text-white bg-gray-500 rounded-md hover:bg-gray-600 transition-all">Load Chart (Online)</button>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button id="export-png-btn" class="flex-1 px-4 py-2 text-sm font-medium text-gray-700 bg-green-200 rounded-md hover:bg-green-300">Export as PNG</button>
                                    <button id="export-svg-btn" class="flex-1 px-4 py-2 text-sm font-medium text-gray-700 bg-green-200 rounded-md hover:bg-green-300">Export as SVG</button>
                                </div>
                            </div>
                        </details>

                        <!-- Data Input Section -->
                        <details open>
                            <summary class="flex items-center justify-between">
                                <span>Data Input</span>
                                <div class="flex items-center gap-2">
                                    <button id="visual-edit-toggle" title="Drag to visually resize chart segments and columns" class="p-1 hover:bg-gray-200 rounded-full">
                                        <svg class="w-5 h-5 text-gray-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                                    </button>
                                    <button id="delete-all-data-btn" title="Delete All Data" class="p-1 hover:bg-gray-200 rounded-full">
                                        <svg class="w-5 h-5 text-red-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                                    </button>
                                    <button id="maximize-grid-btn" title="Maximize Data Grid" class="p-1 hover:bg-gray-200 rounded-full">
                                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 1v4m0 0h-4m4 0l-5-5"></path></svg>
                                    </button>
                                    <span class="accordion-icon ml-2">&gt;</span>
                                </div>
                            </summary>
                            <div class="accordion-content space-y-3 pt-4">
                                <div>
                                    <label for="column-title-input" class="sidebar-label">Column Title:</label>
                                    <div class="font-size-input-wrapper">
                                        <input type="text" id="column-title-input" class="sidebar-input" value="Countries">
                                        <div class="font-size-controls">
                                            <button class="font-size-control-btn" data-target="columnTitleFontSize" data-step="1">▲</button>
                                            <button class="font-size-control-btn" data-target="columnTitleFontSize" data-step="-1">▼</button>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label for="data-title-input" class="sidebar-label">Data Title (for Y-Axis):</label>
                                    <div class="font-size-input-wrapper">
                                        <input type="text" id="data-title-input" class="sidebar-input" value="Share %">
                                         <div class="font-size-controls">
                                            <button class="font-size-control-btn" data-target="dataTitleFontSize" data-step="1">▲</button>
                                            <button class="font-size-control-btn" data-target="dataTitleFontSize" data-step="-1">▼</button>
                                        </div>
                                    </div>
                                </div>
                                <div id="sidebar-grid-container" class="data-grid-container">
                                </div>
                                <button id="transpose-btn" class="w-full px-4 py-2 text-sm font-medium text-white bg-gray-500 rounded-md hover:bg-gray-600">Transpose Table</button>
                            </div>
                        </details>

                        <!-- Chart Appearance Section -->
                        <details>
                            <summary>Chart Appearance <span class="accordion-icon">&gt;</span></summary>
                            <div class="accordion-content space-y-4 pt-4">
                                <div>
                                    <label for="chart-title" class="sidebar-label">Chart Title:</label>
                                    <div class="font-size-input-wrapper">
                                        <input type="text" id="chart-title" class="sidebar-input">
                                        <div class="font-size-controls">
                                            <button class="font-size-control-btn" data-target="chartTitleFontSize" data-step="1">▲</button>
                                            <button class="font-size-control-btn" data-target="chartTitleFontSize" data-step="-1">▼</button>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label class="sidebar-label">Theme:</label>
                                    <select id="theme-preset" class="sidebar-select">
                                        <option value="default">Default</option>
                                        <option value="light">Light</option>
                                        <option value="grey">Grey</option>
                                        <option value="darkGrey">Dark Grey</option>
                                        <option value="pitchBlack">Pitch Black</option>
                                        <option value="techNoir">Tech Noir</option>
                                    </select>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="background-color" class="sidebar-label">Background:</label>
                                        <input type="color" id="background-color" class="w-full h-8 rounded-md border border-gray-300 cursor-pointer">
                                    </div>
                                     <div>
                                        <label for="border-color" class="sidebar-label">Border:</label>
                                        <input type="color" id="border-color" class="w-full h-8 rounded-md border border-gray-300 cursor-pointer">
                                    </div>
                                </div>
                                <div>
                                    <label class="sidebar-label">Segment Color Palette:</label>
                                    <select id="segment-color-palette" class="sidebar-select">
                                        <option value="default">Default</option>
                                        <option value="vibrant">Vibrant</option>
                                        <option value="pastel">Pastel</option>
                                        <option value="earthy">Earthy</option>
                                        <option value="cool">Cool</option>
                                        <option value="warm">Warm</option>
                                        <option value="custom">Custom</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="segment-colors" class="sidebar-label">Custom Colors (hex):</label>
                                    <input type="text" id="segment-colors" class="sidebar-input" placeholder="#4285F4,#EA4335,...">
                                </div>
                            </div>
                        </details>

                        <!-- Axes & Grid Section -->
                        <details>
                            <summary>Axes & Gridlines <span class="accordion-icon">&gt;</span></summary>
                            <div class="accordion-content space-y-4 pt-4">
                                <div>
                                    <label class="sidebar-label">Y-Axis Scale:</label>
                                    <div class="flex items-center space-x-4">
                                        <label class="flex items-center"><input type="radio" name="y-axis-scale" value="absolute" class="form-radio"><span class="ml-2 text-sm">Absolute</span></label>
                                        <label class="flex items-center"><input type="radio" name="y-axis-scale" value="percentage" checked class="form-radio"><span class="ml-2 text-sm">Percentage</span></label>
                                    </div>
                                </div>
                                <div class="space-y-2">
                                     <label class="sidebar-label">Axis Display:</label>
                                     <label class="flex items-center"><input type="checkbox" id="show-x-axis-labels-checkbox" class="form-checkbox"><span class="ml-2 text-sm">X-Axis Labels</span></label>
                                     <label class="flex items-center"><input type="checkbox" id="show-y-axis-labels-checkbox" class="form-checkbox"><span class="ml-2 text-sm">Y-Axis Labels</span></label>
                                     <label class="flex items-center"><input type="checkbox" id="show-x-axis-title-checkbox" class="form-checkbox"><span class="ml-2 text-sm">X-Axis Title</span></label>
                                     <label class="flex items-center"><input type="checkbox" id="show-y-axis-title-checkbox" class="form-checkbox"><span class="ml-2 text-sm">Y-Axis Title</span></label>
                                </div>
                                <div class="space-y-2">
                                    <label class="sidebar-label">Gridlines:</label>
                                    <label class="flex items-center"><input type="checkbox" id="show-gridlines" class="form-checkbox"><span class="ml-2 text-sm">Show Y-Axis Gridlines</span></label>
                                    <div>
                                        <label for="y-axis-ticks" class="sidebar-label text-sm">Gridline Count:</label>
                                        <input type="number" id="y-axis-ticks" class="sidebar-input" value="5" min="1" max="20">
                                    </div>
                                </div>
                            </div>
                        </details>

                        <!-- Labels & Legend Section -->
                        <details>
                            <summary>Labels & Legend <span class="accordion-icon">&gt;</span></summary>
                            <div class="accordion-content space-y-4 pt-4">
                                 <div class="space-y-2">
                                    <label class="sidebar-label">Value Labels:</label>
                                    <label class="flex items-center"><input type="checkbox" id="show-column-totals" class="form-checkbox"><span class="ml-2 text-sm">Show Column Totals</span></label>
                                    <label class="flex items-center"><input type="checkbox" id="abbreviate-totals-checkbox" class="form-checkbox"><span class="ml-2 text-sm">Abbreviate Totals (k, m, b)</span></label>
                                    <label class="flex items-center"><input type="checkbox" id="show-grand-total-checkbox" class="form-checkbox"><span class="ml-2 text-sm">Show Grand Total</span></label>
                                </div>
                                <div class="space-y-2">
                                    <label class="sidebar-label">Segment Data Labels:</label>
                                    <div>
                                        <label for="label-content-type" class="sidebar-label text-sm">Label Content:</label>
                                        <select id="label-content-type" class="sidebar-select">
                                            <option value="none">None</option>
                                            <option value="percentage">Percentage</option>
                                            <option value="value">Absolute Value</option>
                                            <option value="both">Both</option>
                                        </select>
                                    </div>
                                     <div>
                                        <label for="label-precision" class="sidebar-label text-sm">Decimal Places:</label>
                                        <input type="number" id="label-precision" class="sidebar-input" value="0" min="0" max="5">
                                    </div>
                                </div>
                                <div>
                                    <label class="sidebar-label">Overall Font Settings:</label>
                                    <div class="grid grid-cols-2 gap-2">
                                        <select id="font-family" class="sidebar-select">
                                            <option>Lato, sans-serif</option>
                                            <option>Inter, sans-serif</option>
                                            <option>Arial, sans-serif</option>
                                            <option>Verdana, sans-serif</option>
                                        </select>
                                        <input type="number" id="font-size" class="sidebar-input" value="12" min="8" max="30">
                                        <input type="color" id="font-color" class="w-full h-8 rounded-md border border-gray-300 cursor-pointer col-span-2">
                                    </div>
                                </div>
                                 <div>
                                    <label for="legend-font-size" class="sidebar-label">Legend Font Size:</label>
                                    <input type="number" id="legend-font-size" class="sidebar-input" value="12" min="8" max="30">
                                </div>
                                <div>
                                    <label class="sidebar-label">Legend:</label>
                                    <div class="space-y-2">
                                        <select id="legend-placement" class="sidebar-select">
                                            <option value="right">Right of Chart</option>
                                            <option value="below">Below Chart</option>
                                            <option value="above">Above Chart</option>
                                            <option value="none">None</option>
                                        </select>
                                        <!-- MOVED LEGEND TITLE INPUT HERE FOR BETTER UX -->
                                        <div class="mt-2">
                                            <label for="row-title-input" class="sidebar-label text-sm">Legend Title:</label>
                                             <div class="font-size-input-wrapper">
                                                <input type="text" id="row-title-input" class="sidebar-input" value="Generation Type">
                                                <div class="font-size-controls">
                                                    <button class="font-size-control-btn" data-target="rowTitleFontSize" data-step="1">▲</button>
                                                    <button class="font-size-control-btn" data-target="rowTitleFontSize" data-step="-1">▼</button>
                                                </div>
                                            </div>
                                        </div>
                                        <label class="flex items-center"><input type="checkbox" id="show-legend-title-checkbox" class="form-checkbox"><span class="ml-2 text-sm">Show Legend Title</span></label>
                                        <label class="flex items-center"><input type="checkbox" id="show-legend-totals-checkbox" class="form-checkbox"><span class="ml-2 text-sm">Show Row Totals in Legend</span></label>
                                    </div>
                                </div>
                            </div>
                        </details>
                    </div>
                </div>
                
                <!-- ACCOUNT TAB CONTENT -->
                <div id="account-tab-content" class="tab-content hidden">
                    <div class="p-4 space-y-4">
                         <h2 class="text-lg font-bold text-gray-900">User Account</h2>
                         <div id="auth-container">
                            <div id="user-profile" class="hidden">
                                <img id="user-photo" class="w-10 h-10 rounded-full" src="" alt="User Photo">
                                <span id="user-name" class="text-sm font-medium text-gray-800 truncate"></span>
                            </div>
                            <button id="sign-in-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.089,5.571l6.19,5.238C42.021,35.596,44,30.138,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                                <span>Sign in with Google</span>
                            </button>
                            <button id="sign-out-btn" onclick="window.signOutUser()" class="hidden">Sign Out</button>
                        </div>
                         <div id="user-id-display">Initializing...</div>
                    </div>
                </div>
            </div>
        </aside>

        <main id="chart-container">
            <button id="toggle-sidebar-btn">
                <span id="toggle-icon"></span>
            </button>
            <svg id="mekko-chart"></svg>
        </main>
    </div>
    
    <footer id="app-footer">
        <div class="flex items-center gap-4">
            <a href="https://mekkochart.vercel.app/" target="_blank">Quick Mekko Chart &copy; 2025 AV</a>
            <span id="info-icon" title="About this App">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
            </span>
            <span id="feedback-icon" title="Submit Feedback">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-1 12H5v-2h14v2zm0-3H5V9h14v2zm0-3H5V6h14v2z"/>
                </svg>
            </span>
        </div>
        <!-- Auth controls moved to sidebar -->
    </footer>

    <div id="tooltip"></div>
    <div id="loading-indicator">Loading...</div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-message"></h3>
            <div class="modal-buttons">
                <button id="modal-yes-btn" class="modal-button confirm">Yes</button>
                <button id="modal-no-btn" class="modal-button cancel">No</button>
            </div>
        </div>
    </div>

    <!-- About Modal -->
    <div id="about-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" id="about-modal-close-btn">
                 <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h3>About Quick Mekko Chart</h3>
            <p>A simple, powerful tool for creating Mekko charts directly in your browser.</p>
            <h4>Author: Andrius Varanavicius</h4>
            <h4><a href="mailto:andriusv@mail.com?subject=Mekko%20Chart%20App%20Feedback">Send feedback here!</a></h4>
            <h4>Terms of Use:</h4>
            <p>This application is provided "as is", without warranty of any kind. By using this app, you agree to not hold the author liable for any damages or issues arising from its use.</p>
        </div>
    </div>
    
    <!-- Feedback Modal -->
    <div id="feedback-modal" class="modal-overlay">
        <div class="modal-content">
             <button class="modal-close-btn" id="feedback-modal-close-btn">
                 <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h3 class="text-left">Feedback Wall</h3>

			<!-- begin wwww.htmlcommentbox.com -->
			 <div id="HCB_comment_box"><a href="http://www.htmlcommentbox.com">Comment Form</a> is loading comments...</div>
			 <link rel="stylesheet" type="text/css" href="https://www.htmlcommentbox.com/static/skins/bootstrap/twitter-bootstrap.css?v=0" />
			 <script type="text/javascript" id="hcb"> /*<!--*/ if(!window.hcb_user){hcb_user={};} (function(){var s=document.createElement("script"), l=hcb_user.PAGE || (""+window.location).replace(/'/g,"%27"), h="https://www.htmlcommentbox.com";s.setAttribute("type","text/javascript");s.setAttribute("src", h+"/jread?page="+encodeURIComponent(l).replace("+","%2B")+"&mod=%241%24wq1rdBcg%24orI2zCAWzo4Y6rwYJn7Vm%2F"+"&opts=16798&num=10&ts=1752264081598");if (typeof s!="undefined") document.getElementsByTagName("head")[0].appendChild(s);})(); /*-->*/ </script>
			<!-- end www.htmlcommentbox.com -->
				
		</div>
    </div>

    <!-- Fullscreen Data Grid Modal -->
    <div id="data-grid-modal" class="modal-overlay">
        <div class="modal-content">
             <button class="modal-close-btn" id="data-grid-modal-close-btn">
                 <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h3 class="text-left">Data Grid</h3>
            <div id="modal-grid-container" class="data-grid-container">
            </div>
        </div>
    </div>

    <!-- Save Chart Modal -->
    <div id="save-chart-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" id="save-chart-modal-close-btn">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h3>Save Chart Online</h3>
            <label for="chart-name-input" class="sidebar-label text-left block">Chart Name:</label>
            <input type="text" id="chart-name-input" placeholder="Enter chart name" class="sidebar-input">
            <div class="modal-buttons">
                <button id="save-chart-confirm-btn" class="modal-button confirm">Save</button>
                <button id="save-chart-cancel-btn" class="modal-button cancel">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Load Chart Modal -->
    <div id="load-chart-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" id="load-chart-modal-close-btn">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h3 class="text-left">Your Saved Charts</h3>
            <ul id="saved-charts-list">
                <!-- Saved charts will be loaded here -->
            </ul>
        </div>
    </div>


    <script>
        // Global variables
        const margin = { top: 60, right: 40, bottom: 100, left: 80 };
        let width, height;
        let isVisualEditMode = false;

        const defaultData = {
          columnLabels: ['China', 'United States', 'European Union', 'India', 'Japan'],
          rowLabels: ['Coal', 'Natural Gas', 'Hydro', 'Wind', 'Solar'],
          values: [
            [4600, 1000, 333, 2250, 700],
            [1500, 1800, 452, 600, 900],
            [1300, 250, 317, 175, 80],
            [824, 436, 721, 50, 40],
            [584, 238, 246, 113, 100]
          ]
        };

        const defaultChartConfig = {
            chartTitle: 'Electricity Generation by Source in Major Regions (2023, TWh)',
            yAxisScaleType: 'percentage', 
            backgroundColor: '#FFFFFF',
            borderColor: '#E2E8F0',
            segmentColors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#7B1FA2', '#00796B', '#D32F2F', '#C2185B'],
            fontFamily: 'Lato, sans-serif', 
            fontSize: 12,
            fontColor: '#475569',
            legendFontSize: 12,
            chartTitleFontSize: 22,
            rowTitleFontSize: 14,
            columnTitleFontSize: 14,
            dataTitleFontSize: 14,
            labelContentType: 'percentage', // 'none', 'percentage', 'value', 'both'
            labelPrecision: 0,
            showGridlines: false, 
            yAxisTicks: 5,
            showColumnTotals: true,
            abbreviateTotals: true,
            legendPlacement: 'right',
            showLegendTitle: true,
            showXAxisLabels: true,
            showYAxisLabels: true,
            showXAxisTitle: true,
            showYAxisTitle: true,
            showGrandTotal: true,
            showLegendTotals: true,
        };

        const themes = {
            default: { backgroundColor: '#FFFFFF', borderColor: '#E2E8F0', fontColor: '#475569', segmentColors: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#7B1FA2', '#00796B', '#D32F2F', '#C2185B'] },
            light: { backgroundColor: '#f8fafc', borderColor: '#e2e8f0', fontColor: '#1e293b', segmentColors: ['#6366f1', '#a855f7', '#ec4899', '#f97316', '#eab308', '#22c55e', '#06b6d4', '#3b82f6'] },
            grey: { backgroundColor: '#e5e7eb', borderColor: '#9ca3af', fontColor: '#374151', segmentColors: ['#6b7280', '#9ca3af', '#d1d5db', '#e5e7eb', '#4b5563', '#1f2937'] },
            darkGrey: { backgroundColor: '#1f2937', borderColor: '#4b5563', fontColor: '#f9fafb', segmentColors: ['#3b82f6', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#ef4444', '#6b7280', '#9ca3af'] },
            pitchBlack: { backgroundColor: '#000000', borderColor: '#374151', fontColor: '#f9fafb', segmentColors: ['#a78bfa', '#f472b6', '#fbbf24', '#4ade80', '#60a5fa', '#ef4444', '#9ca3af', '#e5e7eb'] },
            techNoir: { backgroundColor: '#111111', borderColor: '#444444', fontColor: '#EAEAEA', segmentColors: ['#B0B0B0', '#888888', '#606060', '#404040', '#282828', '#E0E0E0', '#00A9E0'] }
        };

        const palettes = {
            default: ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#7B1FA2', '#00796B', '#D32F2F', '#C2185B'],
            vibrant: ['#FF6F61', '#6B5B95', '#88B04B', '#F7CAC9', '#92A8CD', '#F4D03F', '#5B5EA6', '#9B2335'],
            pastel: ['#A8DADC', '#457B9D', '#1D3557', '#F4A261', '#E76F51', '#2A9D8F', '#F8EDEB', '#FCD5CE'],
            earthy: ['#6D597A', '#B5838D', '#E5989B', '#FFB4A2', '#FFCDB2', '#A2D2FF', '#83C5BE', '#006D77'],
            cool: ['#264653', '#2A9D8F', '#E9C46A', '#F4A261', '#E76F51', '#5DADE2', '#A9CCE3', '#D6EAF8'],
            warm: ['#D87B6A', '#F2AE72', '#F8D49D', '#F9E795', '#FAD7A0', '#EB984E', '#E67E22', '#BA4A00']
        };

        let chartData = JSON.parse(JSON.stringify(defaultData));
        let chartConfig = JSON.parse(JSON.stringify(defaultChartConfig));
        
        const sidebar = document.getElementById('sidebar');
        const chartContainer = document.getElementById('chart-container');
        const chartSvg = d3.select('#mekko-chart');
        const tooltip = d3.select('#tooltip');
        const toggleIcon = document.getElementById('toggle-icon');
        
        const confirmationModal = document.getElementById('confirmation-modal');
        const aboutModal = document.getElementById('about-modal');
        const dataGridModal = document.getElementById('data-grid-modal');
        const feedbackModal = document.getElementById('feedback-modal');
        const saveChartModal = document.getElementById('save-chart-modal');
        const loadChartModal = document.getElementById('load-chart-modal');
        const loadingIndicator = document.getElementById('loading-indicator');

        let modalOnConfirmCallback = null;

        function showModal(modalEl) { modalEl.classList.add('visible'); }
        function hideModal(modalEl) { modalEl.classList.remove('visible'); }
        
        window.showConfirmationModal = function(message, onConfirm, isAlert = false) {
            document.getElementById('modal-message').textContent = message;
            modalOnConfirmCallback = onConfirm;
            document.getElementById('modal-yes-btn').style.display = isAlert ? 'none' : 'inline-block';
            document.getElementById('modal-no-btn').textContent = isAlert ? 'OK' : 'No';
            showModal(confirmationModal);
        }

        function showLoading(message = "Loading...") {
            loadingIndicator.textContent = message;
            loadingIndicator.style.display = 'block';
        }

        function hideLoading() {
            loadingIndicator.style.display = 'none';
        }

        function getContrastingTextColor(color) {
            const d3Color = d3.color(color);
            if (!d3Color) return '#333333';
            const luma = 0.299 * d3Color.r + 0.587 * d3Color.g + 0.114 * d3Color.b;
            return luma < 128 ? '#FFFFFF' : '#333333';
        }

        function renderDataGrid(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            container.innerHTML = '';
            const table = document.createElement('table');
            table.className = 'data-grid';
            table.innerHTML = `<thead><tr id="${containerId}-col-headers"><th></th></tr></thead><tbody id="${containerId}-data-rows"></tbody>`;
            container.appendChild(table);

            const columnHeadersRow = document.getElementById(`${containerId}-col-headers`);
            const dataRowsBody = document.getElementById(`${containerId}-data-rows`);

            chartData.columnLabels.forEach((label, colIndex) => {
                const th = document.createElement('th');
                const canMoveLeft = colIndex > 0;
                const canMoveRight = colIndex < chartData.columnLabels.length - 1;
                
                th.innerHTML = `
                    <div class="column-header-content">
                        <button class="table-action-button move-col-left-btn" data-col-index="${colIndex}" ${!canMoveLeft ? 'disabled style="opacity:0.3; cursor:not-allowed;"' : ''}>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                        </button>
                        <input type="text" value="${label}" data-col-index="${colIndex}" class="column-label-input">
                        <button class="table-action-button move-col-right-btn" data-col-index="${colIndex}" ${!canMoveRight ? 'disabled style="opacity:0.3; cursor:not-allowed;"' : ''}>
                           <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </button>
                    </div>
                    <div class="column-controls">
                        <button class="table-action-button add-col-btn" data-col-index="${colIndex}" title="Add column right">+</button>
                        <button class="table-action-button remove-col-btn" data-col-index="${colIndex}" title="Remove column">-</button>
                    </div>
                `;
                columnHeadersRow.appendChild(th);
            });

            chartData.values.forEach((rowValues, rowIndex) => {
                const tr = document.createElement('tr');
                const th = document.createElement('th');
                const canMoveUp = rowIndex > 0;
                const canMoveDown = rowIndex < chartData.rowLabels.length - 1;
                th.innerHTML = `
                    <div class="flex items-center justify-center gap-1 p-1">
                        <input type="text" value="${chartData.rowLabels[rowIndex]}" data-row-index="${rowIndex}" class="row-label-input flex-grow">
                        <div class="flex flex-col gap-px">
                            <button class="table-action-button move-row-up-btn" data-row-index="${rowIndex}" title="Move row up" ${!canMoveUp ? 'disabled style="opacity:0.3; cursor:not-allowed;"' : ''}>
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 15l7-7 7 7"></path></svg>
                            </button>
                            <button class="table-action-button move-row-down-btn" data-row-index="${rowIndex}" title="Move row down" ${!canMoveDown ? 'disabled style="opacity:0.3; cursor:not-allowed;"' : ''}>
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7"></path></svg>
                            </button>
                        </div>
                        <div class="flex flex-col gap-px">
                            <button class="table-action-button add-row-btn" data-row-index="${rowIndex}" title="Add row below">+</button>
                            <button class="table-action-button remove-row-btn" data-row-index="${rowIndex}" title="Remove row">-</button>
                        </div>
                    </div>
                `;
                tr.appendChild(th);
                rowValues.forEach((value, colIndex) => {
                    const td = document.createElement('td');
                    td.innerHTML = `<input type="number" value="${value.toFixed(1)}" data-row-index="${rowIndex}" data-col-index="${colIndex}" class="data-value-input">`;
                    tr.appendChild(td);
                });
                dataRowsBody.appendChild(tr);
            });
            addGridEventListeners(containerId);
        }

        function addGridEventListeners(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            const updateAndRedraw = (action) => { action(); drawMekkoChart(); };
            
            container.querySelectorAll('.column-label-input').forEach(input => input.oninput = (e) => updateAndRedraw(() => chartData.columnLabels[e.target.dataset.colIndex] = e.target.value));
            container.querySelectorAll('.row-label-input').forEach(input => input.oninput = (e) => updateAndRedraw(() => chartData.rowLabels[e.target.dataset.rowIndex] = e.target.value));
            container.querySelectorAll('.data-value-input').forEach(input => input.oninput = (e) => updateAndRedraw(() => chartData.values[e.target.dataset.rowIndex][e.target.dataset.colIndex] = parseFloat(e.target.value) || 0));
            
            const reRenderGrids = () => {
                renderDataGrid('sidebar-grid-container');
                if (dataGridModal.classList.contains('visible')) {
                    renderDataGrid('modal-grid-container');
                }
                drawMekkoChart();
            };

            const addRow = (atIndex) => {
                const newRow = Array(chartData.columnLabels.length).fill(0);
                chartData.rowLabels.splice(atIndex + 1, 0, `Segment ${chartData.rowLabels.length + 1}`);
                chartData.values.splice(atIndex + 1, 0, newRow);
                reRenderGrids();
            };
            const removeRow = (atIndex) => {
                if (chartData.rowLabels.length > 1) {
                    chartData.rowLabels.splice(atIndex, 1);
                    chartData.values.splice(atIndex, 1);
                    reRenderGrids();
                }
            };
            const moveRow = (fromIndex, toIndex) => {
                if (toIndex < 0 || toIndex >= chartData.rowLabels.length) return;
                const [label] = chartData.rowLabels.splice(fromIndex, 1);
                chartData.rowLabels.splice(toIndex, 0, label);
                const [rowData] = chartData.values.splice(fromIndex, 1);
                chartData.values.splice(toIndex, 0, rowData);
                reRenderGrids();
            };
            const addColumn = (atIndex) => {
                chartData.columnLabels.splice(atIndex + 1, 0, `Category ${chartData.columnLabels.length + 1}`);
                chartData.values.forEach(row => row.splice(atIndex + 1, 0, 0));
                reRenderGrids();
            };
            const removeColumn = (atIndex) => {
                if (chartData.columnLabels.length > 1) {
                    chartData.columnLabels.splice(atIndex, 1);
                    chartData.values.forEach(row => row.splice(atIndex, 1));
                    reRenderGrids();
                }
            };
            const moveColumn = (fromIndex, toIndex) => {
                if (toIndex < 0 || toIndex >= chartData.columnLabels.length) return;
                const [label] = chartData.columnLabels.splice(fromIndex, 1);
                chartData.columnLabels.splice(toIndex, 0, label);
                chartData.values.forEach(row => {
                    const [value] = row.splice(fromIndex, 1);
                    row.splice(toIndex, 0, value);
                });
                reRenderGrids();
            };

            container.querySelectorAll('.add-col-btn').forEach(b => b.onclick = (e) => addColumn(parseInt(e.currentTarget.dataset.colIndex)));
            container.querySelectorAll('.remove-col-btn').forEach(b => b.onclick = (e) => showConfirmationModal(`Remove column "${chartData.columnLabels[e.currentTarget.dataset.colIndex]}"?`, () => removeColumn(parseInt(e.currentTarget.dataset.colIndex))));
            container.querySelectorAll('.add-row-btn').forEach(b => b.onclick = (e) => addRow(parseInt(e.currentTarget.dataset.rowIndex)));
            container.querySelectorAll('.remove-row-btn').forEach(b => b.onclick = (e) => showConfirmationModal(`Remove row "${chartData.rowLabels[e.currentTarget.dataset.rowIndex]}"?`, () => removeRow(parseInt(e.currentTarget.dataset.rowIndex))));
            container.querySelectorAll('.move-col-left-btn').forEach(b => b.onclick = (e) => moveColumn(parseInt(e.currentTarget.dataset.colIndex), parseInt(e.currentTarget.dataset.colIndex) - 1));
            container.querySelectorAll('.move-col-right-btn').forEach(b => b.onclick = (e) => moveColumn(parseInt(e.currentTarget.dataset.colIndex), parseInt(e.currentTarget.dataset.colIndex) + 1));
            container.querySelectorAll('.move-row-up-btn').forEach(b => b.onclick = (e) => moveRow(parseInt(e.currentTarget.dataset.rowIndex), parseInt(e.currentTarget.dataset.rowIndex) - 1));
            container.querySelectorAll('.move-row-down-btn').forEach(b => b.onclick = (e) => moveRow(parseInt(e.currentTarget.dataset.rowIndex), parseInt(e.currentTarget.dataset.rowIndex) + 1));
        }

        function initializeConfigInputs() {
            const configMap = {
                'chart-title': 'chartTitle', 'background-color': 'backgroundColor', 'border-color': 'borderColor',
                'font-family': 'fontFamily', 'font-size': 'fontSize', 'font-color': 'fontColor', 'legend-font-size': 'legendFontSize',
                'label-precision': 'labelPrecision', 'y-axis-ticks': 'yAxisTicks', 'legend-placement': 'legendPlacement',
                'label-content-type': 'labelContentType', 'show-gridlines': 'showGridlines', 'show-column-totals': 'showColumnTotals',
                'abbreviate-totals-checkbox': 'abbreviateTotals', 'show-x-axis-labels-checkbox': 'showXAxisLabels',
                'show-y-axis-labels-checkbox': 'showYAxisLabels', 'show-x-axis-title-checkbox': 'showXAxisTitle',
                'show-y-axis-title-checkbox': 'showYAxisTitle', 'show-legend-title-checkbox': 'showLegendTitle',
                'show-grand-total-checkbox': 'showGrandTotal', 'show-legend-totals-checkbox': 'showLegendTotals'
            };

            Object.entries(configMap).forEach(([id, key]) => {
                const el = document.getElementById(id);
                if (el) {
                    if (el.type === 'checkbox') el.checked = chartConfig[key];
                    else el.value = chartConfig[key];
                }
            });

            const yAxisScaleRadio = document.querySelector(`input[name="y-axis-scale"][value="${chartConfig.yAxisScaleType}"]`);
            if (yAxisScaleRadio) yAxisScaleRadio.checked = true;
            
            const themePresetSelect = document.getElementById('theme-preset');
            if (themePresetSelect) {
                const currentThemeName = Object.keys(themes).find(themeName => 
                    themes[themeName].backgroundColor === chartConfig.backgroundColor &&
                    themes[themeName].borderColor === chartConfig.borderColor &&
                    themes[themeName].fontColor === chartConfig.fontColor &&
                    JSON.stringify(themes[themeName].segmentColors) === JSON.stringify(chartConfig.segmentColors)
                );
                themePresetSelect.value = currentThemeName || 'default';
            }

            const segmentColorPaletteSelect = document.getElementById('segment-color-palette');
            if (segmentColorPaletteSelect) {
                const currentPaletteName = Object.keys(palettes).find(paletteName => 
                    JSON.stringify(palettes[paletteName]) === JSON.stringify(chartConfig.segmentColors)
                );
                segmentColorPaletteSelect.value = currentPaletteName || 'custom';
            }

            const segmentColorsInput = document.getElementById('segment-colors');
            if (segmentColorsInput) segmentColorsInput.value = chartConfig.segmentColors.join(',');

            document.getElementById('row-title-input').value = document.getElementById('row-title-input').value || defaultData.rowLabels[0];
            document.getElementById('column-title-input').value = document.getElementById('column-title-input').value || defaultData.columnLabels[0];
            document.getElementById('data-title-input').value = document.getElementById('data-title-input').value || "Share %";
        }

        function drawMekkoChart() {
            const containerRect = chartContainer.getBoundingClientRect();
            let currentSvgWidth = containerRect.width;
            let currentSvgHeight = containerRect.height;
            
            let chartContentMargin = { ...margin };
            
            const legendFs = chartConfig.legendFontSize;
            const legendRectSize = 12, legendTextOffset = 17, legendLineHeight = legendFs * 1.5, legendPadding = 10;
            
            let legendTitleHeight = 0;
            if(chartConfig.showLegendTitle && chartConfig.legendPlacement !== 'none') {
                legendTitleHeight = chartConfig.rowTitleFontSize * 1.5;
            }

            if (chartData.rowLabels.length > 0 && chartConfig.legendPlacement !== 'none') {
                const estimateTextWidth = text => text.length * (legendFs * 0.6); 
                if (chartConfig.legendPlacement === 'right') {
                    const maxTextWidth = d3.max(chartData.rowLabels, d => estimateTextWidth(d));
                    chartContentMargin.right += legendRectSize + legendTextOffset + maxTextWidth + legendPadding;
                } else {
                    const legendHeight = Math.ceil(chartData.rowLabels.length / 5) * legendLineHeight + legendPadding + legendTitleHeight;
                    if (chartConfig.legendPlacement === 'below') chartContentMargin.bottom += legendHeight;
                    else if (chartConfig.legendPlacement === 'above') chartContentMargin.top += legendHeight;
                }
            }
            
            width = Math.max(1, currentSvgWidth - chartContentMargin.left - chartContentMargin.right);
            height = Math.max(1, currentSvgHeight - chartContentMargin.top - chartContentMargin.bottom);

            chartSvg.selectAll('*').remove();
            chartSvg.attr('width', currentSvgWidth).attr('height', currentSvgHeight).style('background-color', chartConfig.backgroundColor);
            const g = chartSvg.append('g').attr('transform', `translate(${chartContentMargin.left},${chartContentMargin.top})`);

            const columnTotals = chartData.columnLabels.map((_, i) => d3.sum(chartData.values, d => d[i]));
            const rowTotals = chartData.values.map(row => d3.sum(row));
            const overallTotal = d3.sum(columnTotals);

            if (overallTotal === 0) {
                g.append("text").attr("x", width/2).attr("y", height/2).attr("text-anchor", "middle").attr("fill", chartConfig.fontColor).text("No data to display.");
                return;
            }

            const x = d3.scaleLinear().domain([0, overallTotal]).range([0, width]);
            const y = chartConfig.yAxisScaleType === 'percentage' 
                ? d3.scaleLinear().domain([0, 1]).range([height, 0])
                : d3.scaleLinear().domain([0, d3.max(columnTotals) || 1]).range([height, 0]).nice();
            
            const color = d3.scaleOrdinal(chartConfig.segmentColors).domain(chartData.rowLabels);

            let currentX = 0;
            const chartDataProcessed = chartData.columnLabels.map((colLabel, i) => {
                const colTotal = columnTotals[i];
                const colWidth = x(colTotal);
                let accumulatedYValue = 0;
                const segments = chartData.rowLabels.map((rowLabel, j) => {
                    const value = chartData.values[j][i];
                    const segment = {
                        value: value, x: currentX, width: colWidth,
                        color: color(rowLabel),
                        rowLabel: rowLabel, colLabel: colLabel,
                        rowIndex: j, colIndex: i
                    };
                    
                    if (chartConfig.yAxisScaleType === 'percentage') {
                        const startPercent = colTotal > 0 ? accumulatedYValue / colTotal : 0;
                        const endPercent = colTotal > 0 ? (accumulatedYValue + value) / colTotal : 0;
                        segment.y = y(endPercent);
                        segment.height = y(startPercent) - y(endPercent);
                        segment.displayValue = colTotal > 0 ? (value / colTotal) * 100 : 0;
                    } else {
                        segment.y = y(accumulatedYValue + value);
                        segment.height = y(accumulatedYValue) - y(accumulatedYValue + value);
                        segment.displayValue = value;
                    }

                    accumulatedYValue += value;
                    return segment;
                });
                const columnData = { column: colLabel, segments: segments, x: currentX + colWidth / 2, total: colTotal, colIndex: i };
                currentX += colWidth;
                return columnData;
            });

            const columnGroups = g.selectAll('.column-group').data(chartDataProcessed).enter().append('g').attr('class', 'column-group');

            columnGroups.each(function(d) {
                d3.select(this).selectAll('.segment-rect').data(d.segments).enter().append('rect')
                    .attr('class', 'segment-rect')
                    .attr('x', s => s.x).attr('y', s => s.y).attr('width', s => s.width).attr('height', s => s.height)
                    .attr('fill', s => s.color).attr('stroke', chartConfig.borderColor).attr('stroke-width', 1.5).attr('rx', 4)
                    .on('mouseover', (event, s) => {
                        tooltip.classed('visible', true);
                        let valueText = chartConfig.yAxisScaleType === 'percentage' ? `${s.displayValue.toFixed(chartConfig.labelPrecision)}%` : s.value.toLocaleString();
                        tooltip.html(`<strong>${s.colLabel}</strong><br>${s.rowLabel}: ${valueText}`);
                    })
                    .on('mousemove', (event) => tooltip.style('left', (event.pageX + 15) + 'px').style('top', (event.pageY - 28) + 'px'))
                    .on('mouseout', () => tooltip.classed('visible', false));
            });
            
            if (chartConfig.labelContentType !== 'none') {
                columnGroups.each(function(d) {
                    const labels = d3.select(this).selectAll('.segment-label')
                        .data(d.segments)
                        .enter()
                        .append('text')
                        .attr('class', 'segment-label')
                        .attr('x', s => s.x + s.width / 2)
                        .attr('y', s => s.y + s.height / 2)
                        .attr('font-family', chartConfig.fontFamily)
                        .attr('font-size', `${chartConfig.fontSize * 0.9}px`)
                        .attr('fill', s => getContrastingTextColor(s.color))
                        .attr('visibility', 'hidden'); // Initially hidden

                    labels.each(function(s) {
                        const el = d3.select(this);
                        const contentType = chartConfig.labelContentType;
                        const labelFontSize = chartConfig.fontSize * 0.9;
                        
                        const showLabel = s.width > 20 && s.height > (contentType === 'both' ? labelFontSize * 2.2 : labelFontSize * 1.2);
                        if (!showLabel) return;
                        
                        el.attr('visibility', 'visible');

                        const percText = `${s.displayValue.toFixed(chartConfig.labelPrecision)}%`;
                        const valText = chartConfig.abbreviateTotals ? d3.format(".2s")(s.value).replace(/G/,'B') : s.value.toLocaleString();

                        if (contentType === 'percentage') {
                            el.attr('dy', '0.35em').text(percText);
                        } else if (contentType === 'value') {
                            el.attr('dy', '0.35em').text(valText);
                        } else if (contentType === 'both') {
                            el.append('tspan')
                                .attr('x', s.x + s.width / 2)
                                .attr('dy', '-0.4em')
                                .text(percText);
                            el.append('tspan')
                                .attr('x', s.x + s.width / 2)
                                .attr('dy', '1.2em')
                                .text(valText);
                        }
                    });
                });
            }
            
            if(isVisualEditMode) {
                g.append('g').attr('class', 'drag-handles-horizontal')
                    .selectAll('.horizontal-drag-handle')
                    .data(chartDataProcessed.slice(0, -1))
                    .enter().append('rect')
                    .attr('class', 'horizontal-drag-handle')
                    .attr('x', d => d.segments[0].x + d.segments[0].width - 4)
                    .attr('y', 0).attr('width', 8).attr('height', height)
                    .call(d3.drag().on("drag", handleHorizontalDrag));

                if (chartConfig.yAxisScaleType === 'percentage') {
                    columnGroups.each(function(d_col) {
                        const handleData = d_col.segments.slice(0, -1).map(segment => ({
                            colIndex: segment.colIndex, rowIndex: segment.rowIndex, 
                            x: segment.x, y: segment.y, width: segment.width
                        }));

                        d3.select(this).selectAll('.vertical-drag-handle')
                            .data(handleData).enter().append('rect')
                            .attr('class', 'vertical-drag-handle')
                            .attr('x', h => h.x).attr('y', h => h.y - 2)
                            .attr('width', h => h.width).attr('height', 4)
                            .call(d3.drag().on("drag", handleVerticalDrag));
                    });
                }
            }

            if (chartConfig.showXAxisLabels) {
                const labelNodes = chartDataProcessed.map((d, i) => {
                    let totalStr = chartConfig.showColumnTotals ? ` (${chartConfig.abbreviateTotals ? d3.format(".2s")(d.total).replace(/G/,'B') : d.total.toLocaleString()})` : '';
                    return { index: i, fx: d.x, text: `${d.column}${totalStr}`, sourceX: d.x };
                });

                const simulation = d3.forceSimulation(labelNodes)
                    .force("collide", d3.forceCollide(d => d.text.length * chartConfig.fontSize * 0.3 + 10))
                    .force("x", d3.forceX(d => d.fx).strength(1))
                    .stop();
                for (let i = 0; i < 150; ++i) simulation.tick();

                labelNodes.forEach((node, i) => {
                    node.y = height + chartConfig.fontSize * (i % 2 === 0 ? 2.5 : 4.5);
                });

                const labelGroup = g.append('g').attr('class', 'x-axis-labels');
                labelGroup.selectAll('.leader-line').data(labelNodes).enter().append('line')
                    .attr('class', 'leader-line').attr('x1', d => d.sourceX).attr('y1', height).attr('x2', d => d.x).attr('y2', d => d.y - chartConfig.fontSize * 0.7).attr('stroke', chartConfig.fontColor);
                labelGroup.selectAll('.column-label').data(labelNodes).enter().append('text')
                    .attr('class', 'column-label').attr('x', d => d.x).attr('y', d => d.y).attr('font-family', chartConfig.fontFamily).attr('font-size', `${chartConfig.fontSize}px`).attr('fill', chartConfig.fontColor).text(d => d.text);
            }

            chartSvg.append('text').attr('class', 'chart-title').attr('x', chartContentMargin.left + width/2).attr('y', chartContentMargin.top / 2).attr('font-family', chartConfig.fontFamily).attr('font-size', `${chartConfig.chartTitleFontSize}px`).attr('fill', chartConfig.fontColor).text(chartConfig.chartTitle);
            if (chartConfig.showYAxisTitle) {
                g.append('text').attr('class', 'axis-title').attr('transform', 'rotate(-90)').attr('y', -chartContentMargin.left * 0.75).attr('x', -height/2).attr('font-family', chartConfig.fontFamily).attr('font-size', `${chartConfig.dataTitleFontSize}px`).attr('fill', chartConfig.fontColor).text(document.getElementById('data-title-input').value || 'Value');
            }
            if (chartConfig.showXAxisTitle) {
                g.append('text').attr('class', 'axis-title').attr('x', width/2).attr('y', height + chartContentMargin.bottom * 0.9).attr('font-family', chartConfig.fontFamily).attr('font-size', `${chartConfig.columnTitleFontSize}px`).attr('fill', chartConfig.fontColor).text(document.getElementById('column-title-input').value);
            }

            if (chartConfig.showYAxisLabels) {
                const yAxis = d3.axisLeft(y).ticks(chartConfig.yAxisTicks).tickFormat(d => chartConfig.yAxisScaleType === 'percentage' ? `${d * 100}%` : d3.format(".2s")(d).replace(/G/,'B'));
                g.append('g').attr('class', 'axis y-axis').call(yAxis).selectAll("text").attr("fill", chartConfig.fontColor).attr("font-family", chartConfig.fontFamily).attr("font-size", `${chartConfig.fontSize}px`);
            }
            if (chartConfig.showGridlines) {
                g.append("g").attr("class", "grid y-grid").call(d3.axisLeft(y).ticks(chartConfig.yAxisTicks).tickSize(-width).tickFormat(""));
            }

            if (chartConfig.legendPlacement !== 'none') {
                const legend = chartSvg.append('g').attr('class', 'legend').attr('font-family', chartConfig.fontFamily).attr('fill', chartConfig.fontColor);
                let legendYOffset = 0;

                if (chartConfig.showLegendTitle) {
                    const legendTitleText = document.getElementById('row-title-input').value;
                    legend.append('text')
                        .attr('class', 'legend-title')
                        .attr('font-size', `${chartConfig.rowTitleFontSize}px`)
                        .text(legendTitleText);
                    legendYOffset = chartConfig.rowTitleFontSize * 1.5;
                }
                
                const legendItems = legend.selectAll('.legend-item').data(chartData.rowLabels).enter().append('g').attr('class', 'legend-item');
                legendItems.append('rect').attr('width', legendRectSize).attr('height', legendRectSize).attr('fill', d => color(d)).attr('stroke', chartConfig.borderColor);
                legendItems.append('text').attr('x', legendTextOffset).attr('y', legendRectSize/2).attr('dy', '0.35em').attr('font-size', `${legendFs}px`)
                    .text((d, i) => {
                        if (chartConfig.showLegendTotals) {
                            const total = rowTotals[i];
                            const totalStr = chartConfig.abbreviateTotals ? d3.format(".2s")(total).replace(/G/,'B') : total.toLocaleString();
                            return `${d} (${totalStr})`;
                        }
                        return d;
                    });
                
                if (chartConfig.legendPlacement === 'right') {
                    legend.select('.legend-title').attr('transform', `translate(${chartContentMargin.left + width + legendPadding}, ${chartContentMargin.top})`);
                    legendItems.attr('transform', (d, i) => `translate(${chartContentMargin.left + width + legendPadding}, ${chartContentMargin.top + legendYOffset + i * legendLineHeight})`);
                } else {
                    let xPos = chartContentMargin.left;
                    let yPos = (chartConfig.legendPlacement === 'below') 
                        ? chartContentMargin.top + height + 40
                        : chartContentMargin.top - (legendTitleHeight + Math.ceil(chartData.rowLabels.length / 5) * legendLineHeight + legendPadding);
                    
                    if (chartConfig.showLegendTitle) {
                        legend.select('.legend-title').attr('transform', `translate(${xPos}, ${yPos})`);
                    }

                    const availableWidth = currentSvgWidth - chartContentMargin.left - chartContentMargin.right;
                    legendItems.attr('transform', function() {
                        const itemWidth = this.getBBox().width + 20;
                        if (xPos + itemWidth > chartContentMargin.left + availableWidth) {
                            xPos = chartContentMargin.left; yPos += legendLineHeight;
                        }
                        const transform = `translate(${xPos}, ${yPos + legendYOffset})`;
                        xPos += itemWidth;
                        return transform;
                    });
                }
            }

            if (chartConfig.showGrandTotal) {
                const totalStr = chartConfig.abbreviateTotals ? d3.format(".2s")(overallTotal).replace(/G/,'B') : overallTotal.toLocaleString();
                chartSvg.append('text')
                    .attr('class', 'grand-total')
                    .attr('x', currentSvgWidth - 15)
                    .attr('y', currentSvgHeight - 15)
                    .attr('text-anchor', 'end')
                    .attr('font-family', chartConfig.fontFamily)
                    .attr('font-size', `${chartConfig.fontSize}px`)
                    .attr('font-weight', 'bold')
                    .attr('fill', chartConfig.fontColor)
                    .text(`Grand Total: ${totalStr}`);
            }
        }
        
        function handleHorizontalDrag(event, d) {
            const colIndex1 = d.colIndex;
            const colIndex2 = d.colIndex + 1;

            const total1 = d3.sum(chartData.values, row => row[colIndex1]);
            const total2 = d3.sum(chartData.values, row => row[colIndex2]);
            const combinedTotal = total1 + total2;
            if (combinedTotal === 0) return;

            const overallTotal = d3.sum(chartData.values, row => d3.sum(row));
            const changeInData = (event.dx / width) * overallTotal;

            const newTotal1 = total1 + changeInData;
            const newTotal2 = total2 - changeInData;

            if (newTotal1 < 0 || newTotal2 < 0) return;

            const ratio1 = total1 > 0 ? newTotal1 / total1 : 0;
            const ratio2 = total2 > 0 ? newTotal2 / total2 : 0;

            for (let i = 0; i < chartData.values.length; i++) {
                chartData.values[i][colIndex1] *= ratio1;
                chartData.values[i][colIndex2] *= ratio2;
            }
            
            drawMekkoChart();
            renderDataGrid('sidebar-grid-container');
        }

        function handleVerticalDrag(event, d) {
            const colIndex = d.colIndex;
            const rowIndex1 = d.rowIndex;
            const rowIndex2 = d.rowIndex + 1;

            const colTotal = d3.sum(chartData.values, row => row[colIndex]);
            if (colTotal === 0) return;

            const value1 = chartData.values[rowIndex1][colIndex];
            const value2 = chartData.values[rowIndex2][colIndex];
            
            const changeInValue = -(event.dy / height) * colTotal;

            if (value1 + changeInValue < 0 || value2 - changeInValue < 0) return;

            chartData.values[rowIndex1][colIndex] += changeInValue;
            chartData.values[rowIndex2][colIndex] -= changeInValue;

            drawMekkoChart();
            renderDataGrid('sidebar-grid-container');
        }

        function updateToggleIcon() {
            if (sidebar.classList.contains('hidden')) {
                toggleIcon.innerHTML = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>`;
            } else {
                toggleIcon.innerHTML = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>`;
            }
        }

        async function saveChartOnline() {
            if (!window.firebase || !window.firebase.currentUserId()) {
                showConfirmationModal("You must be signed in to save charts online. Click the 'Sign in with Google' button to continue.", () => {}, true);
                return;
            }

            showModal(saveChartModal);
            document.getElementById('chart-name-input').value = chartConfig.chartTitle;
            document.getElementById('chart-name-input').focus();
        }

        async function confirmSaveChartOnline() {
            hideModal(saveChartModal);
            showLoading("Saving chart...");

            const chartName = document.getElementById('chart-name-input').value.trim();
            if (!chartName) {
                showConfirmationModal("Chart name cannot be empty.", () => {}, true);
                hideLoading();
                return;
            }

            const dataToSave = {
                name: chartName,
                chartData: JSON.stringify(chartData), 
                chartConfig: chartConfig,
                dataTitles: {
                    row: document.getElementById('row-title-input').value,
                    column: document.getElementById('column-title-input').value,
                    data: document.getElementById('data-title-input').value
                },
                timestamp: new Date().toISOString()
            };

            try {
                const chartsCollectionRef = window.firebase.collection(window.firebase.db, `artifacts/${window.firebase.appId}/users/${window.firebase.currentUserId()}/charts`);
                await window.firebase.addDoc(chartsCollectionRef, dataToSave);
                showConfirmationModal("Chart saved successfully!", () => {}, true);
            } catch (e) {
                console.error("Error saving document: ", e);
                showConfirmationModal("Error saving chart: " + e.message, () => {}, true);
            } finally {
                hideLoading();
            }
        }

        async function loadChartsOnline() {
            if (!window.firebase || !window.firebase.currentUserId()) {
                showConfirmationModal("You must be signed in to load charts online. Click the 'Sign in with Google' button to continue.", () => {}, true);
                return;
            }

            showLoading("Loading charts...");
            const savedChartsList = document.getElementById('saved-charts-list');
            savedChartsList.innerHTML = ''; 

            try {
                const chartsCollectionRef = window.firebase.collection(window.firebase.db, `artifacts/${window.firebase.appId}/users/${window.firebase.currentUserId()}/charts`);
                const querySnapshot = await window.firebase.getDocs(chartsCollectionRef);
                
                if (querySnapshot.empty) {
                    savedChartsList.innerHTML = '<li class="text-center text-gray-500">No charts saved yet.</li>';
                } else {
                    const charts = [];
                    querySnapshot.forEach((doc) => {
                        charts.push({ id: doc.id, ...doc.data() });
                    });

                    charts.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                    charts.forEach((chart) => {
                        const li = document.createElement('li');
                        li.dataset.chartId = chart.id;
                        li.innerHTML = `
                            <div class="chart-info" onclick="loadSingleChart('${chart.id}')">
                                <div class="chart-name">${chart.name}</div>
                                <div class="chart-date">${new Date(chart.timestamp).toLocaleString()}</div>
                            </div>
                            <div class="chart-actions">
                                <button class="delete-single-chart-btn" title="Delete Chart">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                                </button>
                            </div>
                        `;
                        savedChartsList.appendChild(li);
                    });

                    savedChartsList.querySelectorAll('.delete-single-chart-btn').forEach(button => {
                        button.onclick = (event) => {
                            event.stopPropagation(); 
                            const chartId = event.currentTarget.closest('li').dataset.chartId;
                            const chartName = event.currentTarget.closest('li').querySelector('.chart-name').textContent;
                            showConfirmationModal(`Are you sure you want to delete "${chartName}"?`, () => deleteSingleChart(chartId));
                        };
                    });
                }
                showModal(loadChartModal);
            } catch (e) {
                console.error("Error loading documents: ", e);
                showConfirmationModal("Error loading charts: " + e.message, () => {}, true);
            } finally {
                hideLoading();
            }
        }

        async function loadSingleChart(chartId) {
            hideModal(loadChartModal);
            showLoading("Loading selected chart...");

            try {
                const chartDocRef = window.firebase.doc(window.firebase.db, `artifacts/${window.firebase.appId}/users/${window.firebase.currentUserId()}/charts`, chartId);
                const docSnap = await window.firebase.getDoc(chartDocRef);

                if (docSnap.exists()) {
                    const chartDataLoaded = docSnap.data();
                    chartData = JSON.parse(chartDataLoaded.chartData); 
                    chartConfig = chartDataLoaded.chartConfig;
                    document.getElementById('row-title-input').value = chartDataLoaded.dataTitles.row;
                    document.getElementById('column-title-input').value = chartDataLoaded.dataTitles.column;
                    document.getElementById('data-title-input').value = chartDataLoaded.dataTitles.data;

                    renderDataGrid('sidebar-grid-container');
                    initializeConfigInputs();
                    drawMekkoChart();
                    showConfirmationModal(`Chart "${chartDataLoaded.name}" loaded successfully!`, () => {}, true);
                } else {
                    showConfirmationModal("Chart not found.", () => {}, true);
                }
            } catch (e) {
                console.error("Error loading chart: ", e);
                showConfirmationModal("Error loading chart: " + e.message, () => {}, true);
            } finally {
                hideLoading();
            }
        }

        async function deleteSingleChart(chartId) {
            hideModal(confirmationModal); 
            showLoading("Deleting chart...");

            try {
                const chartDocRef = window.firebase.doc(window.firebase.db, `artifacts/${window.firebase.appId}/users/${window.firebase.currentUserId()}/charts`, chartId);
                await window.firebase.deleteDoc(chartDocRef);
                loadChartsOnline(); 
            } catch (e) {
                console.error("Error deleting chart: ", e);
                showConfirmationModal("Error deleting chart: " + e.message, () => {}, true);
            } finally {
                hideLoading();
            }
        }
        
        let saveTimeout;
        const debounceSave = (func, delay) => {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(func, delay);
        };

        window.saveUserPreferences = async () => {
            if (!window.firebase || !window.firebase.currentUserId()) return;
            
            const prefs = {
                chartConfig: chartConfig,
                sidebarFontSize: getComputedStyle(document.documentElement).getPropertyValue('--sidebar-base-font-size'),
                lastUpdated: new Date().toISOString()
            };

            try {
                const prefsDocRef = window.firebase.doc(window.firebase.db, `artifacts/${window.firebase.appId}/users/${window.firebase.currentUserId()}/preferences`, 'userPrefs');
                await window.firebase.setDoc(prefsDocRef, prefs, { merge: true });
                console.log("User preferences saved.");
            } catch (e) {
                console.error("Error saving user preferences:", e);
            }
        };

        window.loadUserPreferences = async () => {
            if (!window.firebase || !window.firebase.currentUserId()) return;
            
            try {
                const prefsDocRef = window.firebase.doc(window.firebase.db, `artifacts/${window.firebase.appId}/users/${window.firebase.currentUserId()}/preferences`, 'userPrefs');
                const docSnap = await window.firebase.getDoc(prefsDocRef);

                if (docSnap.exists()) {
                    const prefs = docSnap.data();
                    chartConfig = { ...defaultChartConfig, ...prefs.chartConfig };
                    if (prefs.sidebarFontSize) {
                        document.documentElement.style.setProperty('--sidebar-base-font-size', prefs.sidebarFontSize);
                    }
                    console.log("User preferences loaded.");
                    initializeConfigInputs();
                    drawMekkoChart();
                } else {
                    console.log("No user preferences found. Using defaults.");
                }
            } catch (e) {
                console.error("Error loading user preferences:", e);
            }
        };


        function setupEventListeners() {
            document.getElementById('toggle-sidebar-btn').addEventListener('click', () => {
                sidebar.classList.toggle('hidden');
                updateToggleIcon();
                setTimeout(drawMekkoChart, 300);
            });
            document.getElementById('close-sidebar-btn').addEventListener('click', () => {
                sidebar.classList.add('hidden');
                updateToggleIcon();
                setTimeout(drawMekkoChart, 300);
            });
            
            document.getElementById('increase-sidebar-font').addEventListener('click', () => {
                const currentSize = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--sidebar-base-font-size'));
                document.documentElement.style.setProperty('--sidebar-base-font-size', `${Math.min(20, currentSize + 1)}px`);
                debounceSave(window.saveUserPreferences, 1500);
            });
            document.getElementById('decrease-sidebar-font').addEventListener('click', () => {
                const currentSize = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--sidebar-base-font-size'));
                document.documentElement.style.setProperty('--sidebar-base-font-size', `${Math.max(10, currentSize - 1)}px`);
                debounceSave(window.saveUserPreferences, 1500);
            });

            let isResizing = false;
            document.getElementById('sidebar-resizer').addEventListener('mousedown', () => { isResizing = true; document.body.style.cursor = 'ew-resize'; });
            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;
                sidebar.style.width = `${Math.max(280, e.clientX)}px`;
                drawMekkoChart();
            });
            document.addEventListener('mouseup', () => { isResizing = false; document.body.style.cursor = ''; });

            document.getElementById('sign-in-btn').addEventListener('click', () => window.signInWithGoogle());

            // Sidebar Tab switching logic
            sidebar.addEventListener('click', (e) => {
                if (e.target.matches('.tab-btn')) {
                    const tabName = e.target.dataset.tab;
                    
                    sidebar.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');

                    sidebar.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                    document.getElementById(`${tabName}-tab-content`).classList.remove('hidden');
                }
            });

            document.getElementById('save-data-btn').addEventListener('click', () => {
                const state = { chartData, chartConfig, dataTitles: { row: document.getElementById('row-title-input').value, column: document.getElementById('column-title-input').value, data: document.getElementById('data-title-input').value } };
                const blob = new Blob([JSON.stringify(state, null, 2)], {type: "application/json"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = 'mekko-chart-data.json'; a.click();
                URL.revokeObjectURL(url);
            });
            document.getElementById('load-data-input').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const state = JSON.parse(event.target.result);
                        if (state.chartData && state.chartConfig && state.dataTitles) {
                            chartData = state.chartData;
                            chartConfig = { ...defaultChartConfig, ...state.chartConfig };
                            document.getElementById('row-title-input').value = state.dataTitles.row;
                            document.getElementById('column-title-input').value = state.dataTitles.column;
                            document.getElementById('data-title-input').value = state.dataTitles.data;
                            renderDataGrid('sidebar-grid-container'); initializeConfigInputs(); drawMekkoChart();
                        } else { showConfirmationModal('Invalid data file format.', () => {}, true); }
                    } catch (error) { showConfirmationModal('Error reading the data file.', () => {}, true); }
                };
                reader.readAsText(file);
                e.target.value = '';
            });
            
            document.getElementById('export-png-btn').addEventListener('click', () => {
                const chartElement = document.getElementById('chart-container');
                document.getElementById('toggle-sidebar-btn').style.display = 'none';
                html2canvas(chartElement, { 
                    backgroundColor: chartConfig.backgroundColor,
                    onclone: (clonedDoc) => {
                       const clonedChart = clonedDoc.getElementById('chart-container');
                       clonedChart.style.backgroundColor = chartConfig.backgroundColor;
                    }
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = 'mekko-chart.png';
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    document.getElementById('toggle-sidebar-btn').style.display = 'flex';
                });
            });

            document.getElementById('export-svg-btn').addEventListener('click', () => {
                const svgNode = document.getElementById('mekko-chart').cloneNode(true);
                
                // Explicitly set the background color
                d3.select(svgNode).style('background-color', chartConfig.backgroundColor);

                const serializer = new XMLSerializer();
                let svgString = serializer.serializeToString(svgNode);

                // Create a style block with all necessary CSS rules
                const styles = `
                    .chart-title { font-family: ${chartConfig.fontFamily}; font-size: ${chartConfig.chartTitleFontSize}px; font-weight: 700; text-anchor: middle; fill: ${chartConfig.fontColor}; }
                    .axis-title { font-family: ${chartConfig.fontFamily}; font-size: ${chartConfig.dataTitleFontSize}px; font-weight: 600; text-anchor: middle; fill: ${chartConfig.fontColor}; }
                    .axis text { font-family: ${chartConfig.fontFamily}; font-size: ${chartConfig.fontSize}px; fill: ${chartConfig.fontColor}; }
                    .legend-title { font-family: ${chartConfig.fontFamily}; font-size: ${chartConfig.rowTitleFontSize}px; font-weight: bold; fill: ${chartConfig.fontColor}; }
                    .legend-item text { font-family: ${chartConfig.fontFamily}; font-size: ${chartConfig.legendFontSize}px; fill: ${chartConfig.fontColor}; }
                    .segment-label { font-family: ${chartConfig.fontFamily}; font-size: ${chartConfig.fontSize * 0.9}px; text-anchor: middle; }
                    .column-label { font-family: ${chartConfig.fontFamily}; font-size: ${chartConfig.fontSize}px; text-anchor: middle; fill: ${chartConfig.fontColor}; }
                    .leader-line { stroke: ${chartConfig.fontColor}; stroke-width: 1px; stroke-dasharray: 2,2; }
                    .grand-total { font-family: ${chartConfig.fontFamily}; font-size: ${chartConfig.fontSize}px; font-weight: bold; text-anchor: end; fill: ${chartConfig.fontColor}; }
                `;

                // Inject styles into the SVG
                const defs = '<defs><style type="text/css"><![CDATA[' + styles + ']]></style></defs>';
                svgString = svgString.replace('>', '>' + defs);

                const svgBlob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(svgBlob);
                const a = document.createElement('a');
                a.href = url; a.download = 'mekko-chart.svg'; a.click();
                URL.revokeObjectURL(url);
            });


            document.getElementById('transpose-btn').addEventListener('click', () => {
                const transposedValues = chartData.values[0].map((_, colIndex) => chartData.values.map(row => row[colIndex]));
                [chartData.values, chartData.rowLabels, chartData.columnLabels] = [transposedValues, chartData.columnLabels, chartData.rowLabels];
                const rowTitleEl = document.getElementById('row-title-input');
                const colTitleEl = document.getElementById('column-title-input');
                [rowTitleEl.value, colTitleEl.value] = [colTitleEl.value, rowTitleEl.value];
                renderDataGrid('sidebar-grid-container'); drawMekkoChart();
            });
            
            document.getElementById('visual-edit-toggle').addEventListener('click', (e) => {
                isVisualEditMode = !isVisualEditMode;
                e.currentTarget.classList.toggle('active', isVisualEditMode);
                if (isVisualEditMode && chartConfig.yAxisScaleType !== 'percentage') {
                    showConfirmationModal("Visual editing for row heights is only available in 'Percentage' Y-axis scale mode. Column width editing is still active.", ()=>{}, true);
                }
                drawMekkoChart();
            });

            sidebar.addEventListener('input', (e) => {
                const targetId = e.target.id;
                const targetValue = e.target.type === 'checkbox' ? e.target.checked : e.target.value;

                const configMap = {
                    'chart-title': 'chartTitle', 'background-color': 'backgroundColor', 'border-color': 'borderColor',
                    'font-family': 'fontFamily', 'font-color': 'fontColor', 'legend-font-size': 'legendFontSize',
                    'label-precision': 'labelPrecision', 'y-axis-ticks': 'yAxisTicks', 'legend-placement': 'legendPlacement',
                    'label-content-type': 'labelContentType', 'show-gridlines': 'showGridlines', 'show-column-totals': 'showColumnTotals',
                    'abbreviate-totals-checkbox': 'abbreviateTotals', 'show-x-axis-labels-checkbox': 'showXAxisLabels',
                    'show-y-axis-labels-checkbox': 'showYAxisLabels', 'show-x-axis-title-checkbox': 'showXAxisTitle',
                    'show-y-axis-title-checkbox': 'showYAxisTitle', 'segment-colors': 'segmentColors',
                    'show-legend-title-checkbox': 'showLegendTitle',
                    'show-grand-total-checkbox': 'showGrandTotal', 'show-legend-totals-checkbox': 'showLegendTotals'
                };
                
                if (configMap[targetId]) {
                    chartConfig[configMap[targetId]] = (configMap[targetId] === 'segmentColors') ? targetValue.split(',').map(c=>c.trim()) : targetValue;
                } else if (targetId === 'font-size') {
                    const newSize = parseInt(targetValue);
                    chartConfig.fontSize = newSize;
                    chartConfig.legendFontSize = newSize;
                    chartConfig.chartTitleFontSize = Math.round(newSize * 1.8);
                    chartConfig.rowTitleFontSize = Math.round(newSize * 1.2);
                    chartConfig.columnTitleFontSize = Math.round(newSize * 1.2);
                    chartConfig.dataTitleFontSize = Math.round(newSize * 1.2);
                    initializeConfigInputs();
                } else if (targetId === 'theme-preset') {
                    Object.assign(chartConfig, themes[targetValue]);
                    initializeConfigInputs();
                } else if (targetId === 'segment-color-palette') {
                    if (targetValue !== 'custom') {
                        chartConfig.segmentColors = palettes[targetValue];
                        document.getElementById('segment-colors').value = chartConfig.segmentColors.join(',');
                    }
                } else if (e.target.name === 'y-axis-scale') {
                    chartConfig.yAxisScaleType = targetValue;
                }
                drawMekkoChart();
                debounceSave(window.saveUserPreferences, 1500);
            });
            
            sidebar.addEventListener('click', (e) => {
                const button = e.target.closest('.font-size-control-btn');
                if (!button) return;
                
                const target = button.dataset.target;
                const step = parseInt(button.dataset.step);
                
                chartConfig[target] = (chartConfig[target] || 12) + step;
                drawMekkoChart();
                debounceSave(window.saveUserPreferences, 1500);
            });

            document.getElementById('modal-yes-btn').addEventListener('click', () => { if (modalOnConfirmCallback) modalOnConfirmCallback(); hideModal(confirmationModal); });
            document.getElementById('modal-no-btn').addEventListener('click', () => hideModal(confirmationModal));
            document.getElementById('info-icon').addEventListener('click', () => showModal(aboutModal));
            document.getElementById('about-modal-close-btn').addEventListener('click', () => hideModal(aboutModal));
            document.getElementById('feedback-icon').addEventListener('click', () => showModal(feedbackModal));
            document.getElementById('feedback-modal-close-btn').addEventListener('click', () => hideModal(feedbackModal));
            document.getElementById('maximize-grid-btn').addEventListener('click', () => {
                renderDataGrid('modal-grid-container');
                showModal(dataGridModal);
            });
            document.getElementById('data-grid-modal-close-btn').addEventListener('click', () => {
                hideModal(dataGridModal);
                renderDataGrid('sidebar-grid-container');
            });
        }

        window.onload = () => {
            document.querySelectorAll('.sidebar-accordion details').forEach(detail => {
                detail.removeAttribute('open');
            });

            if (window.innerWidth > 768) {
                sidebar.classList.remove('hidden');
            } else {
                sidebar.classList.add('hidden');
            }
            updateToggleIcon();

            renderDataGrid('sidebar-grid-container');
            initializeConfigInputs();
            setupEventListeners();
            drawMekkoChart();
        };

        window.addEventListener('resize', drawMekkoChart);

    </script>
</body>
</html>
